<HTML>
<HEAD>
<TITLE>
Texture.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL_image.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>

<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;

TextureResource<font color="black">:</font><font color="black">:</font>TextureResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>   
<font color="black">}</font>
TextureResource<font color="black">:</font><font color="black">:</font>~TextureResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>       
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Destroyed texture with id="</font><font color="black">&#60;</font><font color="black">&#60;</font>id;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    glDeleteTextures<font color="black">(</font><font color="maroon">1</font>,<font color="black">&</font>id<font color="black">)</font>;
    id<font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
Texture<font color="black">:</font><font color="black">:</font>Texture<font color="black">(</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>TextureResource<font color="black">&#62;</font> resource<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>resource<font color="black">=</font>resource;
<font color="black">}</font>
Texture<font color="black">:</font><font color="black">:</font>Texture<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
<font color="blue">bool</font> Texture<font color="black">:</font><font color="black">:</font>IsValid<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
<font color="blue">bool</font> Texture<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>TextureResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> TextureResource<font color="black">)</font>;
    glGenTextures<font color="black">(</font><font color="maroon">1</font>,<font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Created texture with id="</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>id;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
<font color="blue">bool</font> Texture<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> std<font color="black">:</font><font color="black">:</font>string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>TextureResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> TextureResource<font color="black">)</font>;
    SDL_Surface <font color="black">*</font>image;
    resource<font color="black">-</font><font color="black">&#62;</font>filename<font color="black">=</font>filename;
    image<font color="black">=</font>IMG_Load<font color="black">(</font>filename.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font><font color="black">(</font>image<font color="black">)</font> 
    <font color="black">{</font>
        GLenum format;
        Create<font color="black">(</font><font color="black">)</font>;

        <font color="blue">if</font> <font color="black">(</font>image<font color="black">-</font><font color="black">&#62;</font>format<font color="black">-</font><font color="black">&#62;</font>BytesPerPixel<font color="black">=</font><font color="black">=</font><font color="maroon">4</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font>image<font color="black">-</font><font color="black">&#62;</font>format<font color="black">-</font><font color="black">&#62;</font>Rshift<font color="black">=</font><font color="black">=</font><font color="maroon">16</font><font color="black">)</font>
                format<font color="black">=</font>GL_BGRA;
            <font color="blue">else</font>
                format<font color="black">=</font>GL_RGBA;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font>image<font color="black">-</font><font color="black">&#62;</font>format<font color="black">-</font><font color="black">&#62;</font>BytesPerPixel<font color="black">=</font><font color="black">=</font><font color="maroon">3</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font>image<font color="black">-</font><font color="black">&#62;</font>format<font color="black">-</font><font color="black">&#62;</font>Rshift<font color="black">=</font><font color="black">=</font><font color="maroon">16</font><font color="black">)</font>
                format<font color="black">=</font>GL_BGR;
            <font color="blue">else</font>
                format<font color="black">=</font>GL_RGB;
        <font color="black">}</font>

        glBindTexture<font color="black">(</font>GL_TEXTURE_2D,resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
        glTexParameteri<font color="black">(</font>GL_TEXTURE_2D,GL_GENERATE_MIPMAP,GL_TRUE<font color="black">)</font>;
        glTexImage2D<font color="black">(</font>GL_TEXTURE_2D,<font color="maroon">0</font>,image<font color="black">-</font><font color="black">&#62;</font>format<font color="black">-</font><font color="black">&#62;</font>BytesPerPixel,image<font color="black">-</font><font color="black">&#62;</font>w,image<font color="black">-</font><font color="black">&#62;</font>h,<font color="maroon">0</font>,format,GL_UNSIGNED_BYTE,image<font color="black">-</font><font color="black">&#62;</font>pixels<font color="black">)</font>;       
        glTexParameteri<font color="black">(</font>GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,GL_LINEAR_MIPMAP_LINEAR<font color="black">)</font>;
        glTexParameteri<font color="black">(</font>GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,GL_LINEAR_MIPMAP_LINEAR<font color="black">)</font>;
        SDL_FreeSurface<font color="black">(</font>image<font color="black">)</font>;     
        <font color="blue">return</font> <font color="blue">true</font>;
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>
<font color="blue">void</font> Texture<font color="black">:</font><font color="black">:</font>GenerateMipMaps<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glBindTexture<font color="black">(</font>GL_TEXTURE_2D,resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
    glGenerateMipmapEXT<font color="black">(</font>GL_TEXTURE_2D<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Texture<font color="black">:</font><font color="black">:</font>SetFiltering<font color="black">(</font>TextureFilter minFilter,TextureFilter magFilter<font color="black">)</font>
<font color="black">{</font>
    GLint min,mag;

    <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>NEAREST<font color="black">)</font>
        min<font color="black">=</font>GL_NEAREST;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>LINEAR<font color="black">)</font>
        min<font color="black">=</font>GL_LINEAR;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>MIPMAP<font color="black">)</font>
        min<font color="black">=</font>GL_LINEAR_MIPMAP_LINEAR;

    <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>NEAREST<font color="black">)</font>
        mag<font color="black">=</font>GL_NEAREST;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>LINEAR<font color="black">)</font>
        mag<font color="black">=</font>GL_LINEAR;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>minFilter<font color="black">=</font><font color="black">=</font>MIPMAP<font color="black">)</font>
        mag<font color="black">=</font>GL_LINEAR_MIPMAP_LINEAR;

    glBindTexture<font color="black">(</font>GL_TEXTURE_2D,resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D,GL_TEXTURE_MIN_FILTER,min<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D,GL_TEXTURE_MAG_FILTER,mag<font color="black">)</font>;

<font color="black">}</font>
string Texture<font color="black">:</font><font color="black">:</font>GetFileName<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>filename;
<font color="black">}</font>
<font color="blue">unsigned</font> <font color="blue">int</font> Texture<font color="black">:</font><font color="black">:</font>GetId<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id;
<font color="black">}</font>
Texture<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Texture<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Texture <font color="black">&</font>texture<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> texture.resource<font color="black">=</font><font color="black">=</font>resource;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
