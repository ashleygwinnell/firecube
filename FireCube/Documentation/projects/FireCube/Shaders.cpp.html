<HTML>
<HEAD>
<TITLE>
Shaders.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;ft2build.h&#62;</font>
<font color="blue">#include</font> FT_FREETYPE_H
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>

<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Geometry.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"RenderQueue.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;

ShaderResource<font color="black">:</font><font color="black">:</font>ShaderResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>   
<font color="black">}</font>
ShaderResource<font color="black">:</font><font color="black">:</font>~ShaderResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glDeleteShader<font color="black">(</font>id<font color="black">)</font>;
<font color="black">}</font>
Shader<font color="black">:</font><font color="black">:</font>Shader<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Shader<font color="black">:</font><font color="black">:</font>Shader<font color="black">(</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>ShaderResource<font color="black">&#62;</font> resource<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>resource<font color="black">=</font>resource;
<font color="black">}</font>
<font color="blue">bool</font> Shader<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>ShaderResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;
    GLenum shaderType;
    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glDeleteShader<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;

    string<font color="black">:</font><font color="black">:</font>size_type d;
    d<font color="black">=</font>filename.find_last_of<font color="black">(</font><font color="maroon">"."</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>d<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
    <font color="black">{</font>
        string ext<font color="black">=</font>ToLower<font color="black">(</font>filename.substr<font color="black">(</font>d<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"vert"</font><font color="black">)</font>
            shaderType<font color="black">=</font>GL_VERTEX_SHADER;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"frag"</font><font color="black">)</font>
            shaderType<font color="black">=</font>GL_FRAGMENT_SHADER;
        <font color="blue">else</font>
            <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">=</font>glCreateShader<font color="black">(</font>shaderType<font color="black">)</font>;
    ifstream f<font color="black">(</font>filename.c_str<font color="black">(</font><font color="black">)</font>,ios<font color="black">:</font><font color="black">:</font>in<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>binary<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>ate<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>f.is_open<font color="black">(</font><font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>       
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>   
    <font color="blue">unsigned</font> <font color="blue">int</font> l<font color="black">=</font><font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>f.tellg<font color="black">(</font><font color="black">)</font>;
    <font color="blue">char</font> <font color="black">*</font>buffer<font color="black">=</font><font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>l<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
    f.seekg<font color="black">(</font><font color="maroon">0</font>,ios_base<font color="black">:</font><font color="black">:</font>beg<font color="black">)</font>;
    f.read<font color="black">(</font>buffer,l<font color="black">)</font>;
    buffer<font color="black">[</font>l<font color="black">]</font><font color="black">=</font><font color="maroon">0</font>;
    glShaderSource<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="maroon">1</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>buffer,NULL<font color="black">)</font>;      
    glCompileShader<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
    <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> buffer;

    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
Shader<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Shader<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Shader <font color="black">&</font>shader<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> shader.resource<font color="black">=</font><font color="black">=</font>resource;
<font color="black">}</font>
<font color="blue">bool</font> Shader<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font>ShaderType type,<font color="blue">const</font> string <font color="black">&</font>source<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>ShaderResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;
    GLenum glShaderType;
    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glDeleteShader<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>type<font color="black">=</font><font color="black">=</font>VERTEX_SHADER<font color="black">)</font>
        glShaderType<font color="black">=</font>GL_VERTEX_SHADER;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>type<font color="black">=</font><font color="black">=</font>FRAGMENT_SHADER<font color="black">)</font>
        glShaderType<font color="black">=</font>GL_FRAGMENT_SHADER;
    <font color="blue">else</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    <font color="blue">const</font> <font color="blue">char</font> <font color="black">*</font>buffer<font color="black">=</font>source.c_str<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">=</font>glCreateShader<font color="black">(</font>glShaderType<font color="black">)</font>;  
    glShaderSource<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="maroon">1</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>buffer,NULL<font color="black">)</font>;      
    glCompileShader<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;  

    <font color="blue">return</font> <font color="blue">true</font>;

<font color="black">}</font>
<font color="blue">unsigned</font> <font color="blue">int</font> Shader<font color="black">:</font><font color="black">:</font>GetId<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id;
<font color="black">}</font>
ProgramResource<font color="black">:</font><font color="black">:</font>ProgramResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
ProgramResource<font color="black">:</font><font color="black">:</font>~ProgramResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Destroyed program with id="</font><font color="black">&#60;</font><font color="black">&#60;</font>id;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    glDeleteProgram<font color="black">(</font>id<font color="black">)</font>;
    id<font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>ProgramResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> ProgramResource<font color="black">)</font>;
    
    resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">=</font>glCreateProgram<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>variables.clear<font color="black">(</font><font color="black">)</font>;
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Created program with id="</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>id;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font>Shader shader1,Shader shader2<font color="black">)</font>
<font color="black">{</font>
    Create<font color="black">(</font><font color="black">)</font>;
    Attach<font color="black">(</font>shader1<font color="black">)</font>;
    Attach<font color="black">(</font>shader2<font color="black">)</font>;
    Link<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Attach<font color="black">(</font>Shader shader<font color="black">)</font>
<font color="black">{</font>
    glAttachShader<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,shader.GetId<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Link<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>variables.clear<font color="black">(</font><font color="black">)</font>;
    glLinkProgram<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;    
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">float</font> value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
        glUniform1f<font color="black">(</font>location,value<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">int</font> value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
        glUniform1i<font color="black">(</font>location,value<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,vec3 value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
        glUniform3fv<font color="black">(</font>location,<font color="maroon">1</font>,<font color="black">&</font>value.x<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,vec4 value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
        glUniform4fv<font color="black">(</font>location,<font color="maroon">1</font>,<font color="black">&</font>value.x<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">bool</font> value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>   
        glUniform1i<font color="black">(</font>location,value<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">const</font> vector<font color="black">&#60;</font><font color="blue">bool</font><font color="black">&#62;</font> <font color="black">&</font>value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    vector<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font> tmp;
    <font color="blue">for</font> <font color="black">(</font>vector<font color="black">&#60;</font><font color="blue">bool</font><font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>const_iterator i<font color="black">=</font>value.begin<font color="black">(</font><font color="black">)</font>;i<font color="black">!</font><font color="black">=</font>value.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        tmp.push_back<font color="black">(</font><font color="black">*</font>i<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>   
        glUniform1iv<font color="black">(</font>location,value.size<font color="black">(</font><font color="black">)</font>,<font color="black">&</font>tmp<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetUniform<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">const</font> vector<font color="black">&#60;</font><font color="blue">int</font><font color="black">&#62;</font> <font color="black">&</font>value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>   
        glUniform1iv<font color="black">(</font>location,value.size<font color="black">(</font><font color="black">)</font>,<font color="black">&</font>value<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>SetAttribute<font color="black">(</font><font color="blue">const</font> std<font color="black">:</font><font color="black">:</font>string <font color="black">&</font><font color="blue">name</font>,Buffer buffer,<font color="blue">int</font> size<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">-1</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetAttribLocation<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
            resource<font color="black">-</font><font color="black">&#62;</font>variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">-1</font><font color="black">)</font>
    <font color="black">{</font>       
        buffer.Bind<font color="black">(</font><font color="black">)</font>;
        glVertexAttribPointer<font color="black">(</font>location,size,GL_FLOAT,GL_FALSE,<font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;
        glEnableVertexAttribArray<font color="black">(</font>location<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
string Program<font color="black">:</font><font color="black">:</font>GetInfoLog<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">int</font> infologLength <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">int</font> charsWritten  <font color="black">=</font> <font color="maroon">0</font>;
    <font color="blue">char</font> <font color="black">*</font>infoLog;
    string ret;
    glGetProgramiv<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id, GL_INFO_LOG_LENGTH,<font color="black">&</font>infologLength<font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>infologLength <font color="black">&#62;</font> <font color="maroon">0</font><font color="black">)</font>
    <font color="black">{</font>
        infoLog <font color="black">=</font> <font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>infologLength<font color="black">]</font>;
        glGetProgramInfoLog<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>id, infologLength, <font color="black">&</font>charsWritten, infoLog<font color="black">)</font>;
        ret<font color="black">=</font>infoLog;
        <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> infoLog;
    <font color="black">}</font>
    <font color="blue">return</font> ret;

<font color="black">}</font>
<font color="blue">bool</font> Program<font color="black">:</font><font color="black">:</font>IsValid<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
<font color="blue">unsigned</font> <font color="blue">int</font> Program<font color="black">:</font><font color="black">:</font>GetId<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>id;
<font color="black">}</font>
Program<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Program<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Program <font color="black">&</font>program<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> program.resource<font color="black">=</font><font color="black">=</font>resource;
<font color="black">}</font>

<font color="blue">void</font> Technique<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>TechniqueResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> TechniqueResource<font color="black">)</font>;
<font color="black">}</font>
Technique<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Technique<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Technique <font color="black">&</font>technique<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> technique.resource<font color="black">=</font><font color="black">=</font>resource;
<font color="black">}</font>
<font color="blue">bool</font> Technique<font color="black">:</font><font color="black">:</font>LoadShader<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    string <font color="blue">name</font><font color="black">=</font>Application<font color="black">:</font><font color="black">:</font>SearchForFileName<font color="black">(</font>filename<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font><font color="blue">name</font>.empty<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    string <font color="black">*</font>source;
    string<font color="black">:</font><font color="black">:</font>size_type d;
    d<font color="black">=</font>filename.find_last_of<font color="black">(</font><font color="maroon">"."</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>d<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
    <font color="black">{</font>
        string ext<font color="black">=</font>ToLower<font color="black">(</font>filename.substr<font color="black">(</font>d<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"vert"</font><font color="black">)</font>
            source<font color="black">=</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>vertexShaderCode;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"frag"</font><font color="black">)</font>
            source<font color="black">=</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>fragmentShaderCode;
        <font color="blue">else</font>
            <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>
    ifstream f<font color="black">(</font><font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>f.is_open<font color="black">(</font><font color="black">)</font><font color="black">)</font>   
        <font color="blue">return</font> <font color="blue">false</font>;
        
    <font color="black">*</font>source<font color="black">=</font>string<font color="black">(</font><font color="black">(</font>std<font color="black">:</font><font color="black">:</font>istreambuf_iterator<font color="black">&#60;</font><font color="blue">char</font><font color="black">&#62;</font><font color="black">(</font>f<font color="black">)</font><font color="black">)</font>, std<font color="black">:</font><font color="black">:</font>istreambuf_iterator<font color="black">&#60;</font><font color="blue">char</font><font color="black">&#62;</font><font color="black">(</font><font color="black">)</font><font color="black">)</font>;  
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
Program Technique<font color="black">:</font><font color="black">:</font>GenerateProgram<font color="black">(</font><font color="blue">const</font> RenderState <font color="black">&</font>renderState<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">unsigned</font> <font color="blue">int</font> key<font color="black">=</font>renderState.ToInt<font color="black">(</font><font color="black">)</font>;
    map<font color="black">&#60;</font><font color="blue">unsigned</font> <font color="blue">int</font>,Program<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>programs.find<font color="black">(</font>key<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>programs.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">return</font> i<font color="black">-</font><font color="black">&#62;</font>second;
    
    ostringstream defines;
    <font color="blue">if</font> <font color="black">(</font>renderState.diffuseTexture<font color="black">)</font>
        defines <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"#define DIFFUSE_MAPPING"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.directionalLighting<font color="black">)</font>
        defines <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"#define DIRECTIONAL_LIGHTING"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.fog<font color="black">)</font>
        defines <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"#define FOG"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.normalTexture<font color="black">)</font>
        defines <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"#define NORMAL_MAPPING"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.pointLighting<font color="black">)</font>
        defines <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"#define POINT_LIGHTING"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    ostringstream vertexShaderSource;
    ostringstream fragmentShaderSource;
    Shader vertexShader,fragmentShader;
    vertexShaderSource <font color="black">&#60;</font><font color="black">&#60;</font> defines.str<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> resource<font color="black">-</font><font color="black">&#62;</font>vertexShaderCode;
    fragmentShaderSource <font color="black">&#60;</font><font color="black">&#60;</font> defines.str<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> resource<font color="black">-</font><font color="black">&#62;</font>fragmentShaderCode;
    Program p;
    vertexShader.Create<font color="black">(</font>VERTEX_SHADER,vertexShaderSource.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    fragmentShader.Create<font color="black">(</font>FRAGMENT_SHADER,fragmentShaderSource.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    p.Create<font color="black">(</font>vertexShader,fragmentShader<font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>programs<font color="black">[</font>key<font color="black">]</font><font color="black">=</font>p;
    <font color="blue">return</font> p;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
