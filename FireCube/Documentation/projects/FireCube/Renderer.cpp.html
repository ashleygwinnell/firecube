<HTML>
<HEAD>
<TITLE>
Renderer.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL/SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;ft2build.h&#62;</font>
<font color="blue">#include</font> FT_FREETYPE_H
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">"FireCube.h"</font>
<font color="blue">#include</font> <font color="maroon">"privateFont.h"</font>
<font color="blue">using</font> <font color="blue">namespace</font> FireCube;

ShaderResource<font color="black">:</font><font color="black">:</font>ShaderResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>   
<font color="black">}</font>
ShaderResource<font color="black">:</font><font color="black">:</font>~ShaderResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glDeleteShader<font color="black">(</font>id<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> ShaderResource<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    GLenum shaderType;
    <font color="blue">if</font> <font color="black">(</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glDeleteShader<font color="black">(</font>id<font color="black">)</font>;
    
    string<font color="black">:</font><font color="black">:</font>size_type d;
    d<font color="black">=</font>filename.find_last_of<font color="black">(</font><font color="maroon">"."</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>d<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
    <font color="black">{</font>
        string ext<font color="black">=</font>ToLower<font color="black">(</font>filename.substr<font color="black">(</font>d<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"vshader"</font><font color="black">)</font>
            shaderType<font color="black">=</font>GL_VERTEX_SHADER;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"pshader"</font><font color="black">)</font>
            shaderType<font color="black">=</font>GL_FRAGMENT_SHADER;
        <font color="blue">else</font>
            <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>

    id<font color="black">=</font>glCreateShader<font color="black">(</font>shaderType<font color="black">)</font>;
    ifstream f<font color="black">(</font>filename.c_str<font color="black">(</font><font color="black">)</font>,ios<font color="black">:</font><font color="black">:</font>in<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>binary<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>ate<font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>f.is_open<font color="black">(</font><font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>       
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>   
    DWORD l<font color="black">=</font>f.tellg<font color="black">(</font><font color="black">)</font>;
    <font color="blue">char</font> <font color="black">*</font>buffer<font color="black">=</font><font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>l<font color="black">+</font><font color="maroon">1</font><font color="black">]</font>;
    f.seekg<font color="black">(</font><font color="maroon">0</font>,ios_base<font color="black">:</font><font color="black">:</font>beg<font color="black">)</font>;
    f.read<font color="black">(</font>buffer,l<font color="black">)</font>;
    buffer<font color="black">[</font>l<font color="black">]</font><font color="black">=</font><font color="maroon">0</font>;
    glShaderSource<font color="black">(</font>id,<font color="maroon">1</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>buffer,NULL<font color="black">)</font>;        
    glCompileShader<font color="black">(</font>id<font color="black">)</font>;
    <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> buffer;

    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">bool</font> ShaderResource<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font>ShaderType type,<font color="blue">const</font> string <font color="black">&</font>source<font color="black">)</font>
<font color="black">{</font>
    GLenum glShaderType;
    <font color="blue">if</font> <font color="black">(</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glDeleteShader<font color="black">(</font>id<font color="black">)</font>;
    
    <font color="blue">if</font> <font color="black">(</font>type<font color="black">=</font><font color="black">=</font>VERTEX_SHADER<font color="black">)</font>
        glShaderType<font color="black">=</font>GL_VERTEX_SHADER;
    <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>type<font color="black">=</font><font color="black">=</font>PIXEL_SHADER<font color="black">)</font>
        glShaderType<font color="black">=</font>GL_FRAGMENT_SHADER;
    <font color="blue">else</font>
            <font color="blue">return</font> <font color="blue">false</font>;
    
    <font color="blue">const</font> <font color="blue">char</font> <font color="black">*</font>buffer<font color="black">=</font>source.c_str<font color="black">(</font><font color="black">)</font>;
    id<font color="black">=</font>glCreateShader<font color="black">(</font>glShaderType<font color="black">)</font>;    
    glShaderSource<font color="black">(</font>id,<font color="maroon">1</font>,<font color="black">(</font><font color="blue">const</font> <font color="blue">char</font><font color="black">*</font><font color="black">*</font><font color="black">)</font><font color="black">&</font>buffer,NULL<font color="black">)</font>;        
    glCompileShader<font color="black">(</font>id<font color="black">)</font>;    

    <font color="blue">return</font> <font color="blue">true</font>;

<font color="black">}</font>
Program<font color="black">:</font><font color="black">:</font>Program<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Program<font color="black">:</font><font color="black">:</font>~Program<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glDeleteProgram<font color="black">(</font>id<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glDeleteProgram<font color="black">(</font>id<font color="black">)</font>;
    
    id<font color="black">=</font>glCreateProgram<font color="black">(</font><font color="black">)</font>;
    variables.clear<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font>Shader shader1,Shader shader2<font color="black">)</font>
<font color="black">{</font>
    Create<font color="black">(</font><font color="black">)</font>;
    Attach<font color="black">(</font>shader1<font color="black">)</font>;
    Attach<font color="black">(</font>shader2<font color="black">)</font>;
    Link<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Attach<font color="black">(</font>Shader shader<font color="black">)</font>
<font color="black">{</font>
    glAttachShader<font color="black">(</font>id,shader<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Link<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glLinkProgram<font color="black">(</font>id<font color="black">)</font>;  
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Uniform1f<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">float</font> value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">0</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
            variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glUniform1f<font color="black">(</font>location,value<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Program<font color="black">:</font><font color="black">:</font>Uniform1i<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,<font color="blue">int</font> value<font color="black">)</font>
<font color="black">{</font>
    GLint location<font color="black">=</font><font color="maroon">0</font>;
    map<font color="black">&#60;</font>string,GLint<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>variables.find<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>variables.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        location<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>second;
    <font color="blue">else</font>
    <font color="black">{</font>
        location<font color="black">=</font>glGetUniformLocation<font color="black">(</font>id,<font color="blue">name</font>.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
            variables<font color="black">[</font><font color="blue">name</font><font color="black">]</font><font color="black">=</font>location;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>location<font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        glUniform1i<font color="black">(</font>location,value<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> Program<font color="black">:</font><font color="black">:</font>IsValid<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> id<font color="black">!</font><font color="black">=</font><font color="maroon">0</font>;
<font color="black">}</font>
Renderer<font color="black">:</font><font color="black">:</font>Renderer<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>
Renderer<font color="black">:</font><font color="black">:</font>~Renderer<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>Clear<font color="black">(</font>vec4 color,<font color="blue">float</font> depth<font color="black">)</font>
<font color="black">{</font>
    glClearColor<font color="black">(</font>color.x,color.y,color.z,color.w<font color="black">)</font>;
    glClearDepth<font color="black">(</font>depth<font color="black">)</font>;
    glClear<font color="black">(</font>GL_COLOR_BUFFER_BIT <font color="black">|</font> GL_DEPTH_BUFFER_BIT<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SetModelViewMatrix<font color="black">(</font>mat4 <font color="black">&</font>m<font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_MODELVIEW<font color="black">)</font>;
    glLoadMatrixf<font color="black">(</font>m.m<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SetProjectionMatrix<font color="black">(</font>mat4 <font color="black">&</font>m<font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_PROJECTION<font color="black">)</font>;
    glLoadMatrixf<font color="black">(</font>m.m<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>Render<font color="black">(</font>Model model<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>model<font color="black">)</font>
        <font color="blue">return</font>;

    vector<font color="black">&#60;</font>Object<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>model<font color="black">-</font><font color="black">&#62;</font>object.begin<font color="black">(</font><font color="black">)</font>;   
    
    <font color="blue">for</font> <font color="black">(</font>;i<font color="black">!</font><font color="black">=</font>model<font color="black">-</font><font color="black">&#62;</font>object.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>   
        vector<font color="black">&#60;</font>Mesh<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator j<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>mesh.begin<font color="black">(</font><font color="black">)</font>;
        i<font color="black">-</font><font color="black">&#62;</font>vertexBuffer.SetVertexStream<font color="black">(</font><font color="maroon">3</font><font color="black">)</font>;
        i<font color="black">-</font><font color="black">&#62;</font>uvBuffer.SetTexCoordStream<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
        i<font color="black">-</font><font color="black">&#62;</font>normalBuffer.SetNormalStream<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>;j<font color="black">!</font><font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>mesh.end<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            UseMaterial<font color="black">(</font><font color="black">*</font>j<font color="black">-</font><font color="black">&#62;</font>material<font color="black">)</font>;
            j<font color="black">-</font><font color="black">&#62;</font>indexBuffer.SetIndexStream<font color="black">(</font><font color="black">)</font>;
            RenderIndexStream<font color="black">(</font>TRIANGLES,j<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">3</font><font color="black">)</font>;          
        <font color="black">}</font>
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SaveModelViewMatrix<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_MODELVIEW<font color="black">)</font>;
    glPushMatrix<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>RestoreModelViewMatrix<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_MODELVIEW<font color="black">)</font>;
    glPopMatrix<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SaveProjectionMatrix<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_PROJECTION<font color="black">)</font>;
    glPushMatrix<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>RestoreProjectionMatrix<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_PROJECTION<font color="black">)</font>;
    glPopMatrix<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>MultiplyModelViewMatrix<font color="black">(</font>mat4 <font color="black">&</font>mat<font color="black">)</font>
<font color="black">{</font>
    glMatrixMode<font color="black">(</font>GL_MODELVIEW<font color="black">)</font>;
    glMultMatrixf<font color="black">(</font>mat.m<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>UseTexture<font color="black">(</font>Texture tex,<font color="blue">unsigned</font> <font color="blue">int</font> unit<font color="black">)</font>
<font color="black">{</font>
    glActiveTexture<font color="black">(</font>GL_TEXTURE0<font color="black">+</font>unit<font color="black">)</font>;
    glBindTexture<font color="black">(</font>GL_TEXTURE_2D,tex<font color="black">-</font><font color="black">&#62;</font>id<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>RenderText<font color="black">(</font>Font font,vec2 pos,<font color="blue">const</font> string <font color="black">&</font>str<font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>font<font color="black">)</font>
        <font color="blue">return</font>;
    <font color="blue">if</font> <font color="black">(</font>textShader.IsValid<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        UseProgram<font color="black">(</font>textShader<font color="black">)</font>;
    <font color="blue">else</font>
    <font color="black">{</font>
        Shader vshader<font color="black">=</font>Shader<font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;
        Shader pshader<font color="black">=</font>Shader<font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;              

        vshader<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>VERTEX_SHADER,<font color="maroon">"void main() \
        {   \
            gl_TexCoord[0]=gl_MultiTexCoord0; \
            gl_Position = ftransform(); \
        } "</font><font color="black">)</font>;
        
        pshader<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>PIXEL_SHADER,<font color="maroon">"uniform sampler2D tex0; \
        void main() \
        { \
        gl_FragColor = texture2D(tex0,gl_TexCoord[0].st);  \
        } "</font><font color="black">)</font>;
        textShader.Create<font color="black">(</font>vshader,pshader<font color="black">)</font>;
        UseProgram<font color="black">(</font>textShader<font color="black">)</font>;
    <font color="black">}</font>
    textShader.Uniform1i<font color="black">(</font><font color="maroon">"tex0"</font>,<font color="maroon">0</font><font color="black">)</font>;
    Buffer vb,uvb;
    vb.Create<font color="black">(</font><font color="black">)</font>;
    uvb.Create<font color="black">(</font><font color="black">)</font>;
    <font color="blue">int</font> numQuads<font color="black">=</font><font color="maroon">0</font>;
    vec2 <font color="black">*</font>vBuffer<font color="black">=</font><font color="blue">new</font> vec2<font color="black">[</font>str.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">4</font><font color="black">]</font>;
    vec2 <font color="black">*</font>uvBuffer<font color="black">=</font><font color="blue">new</font> vec2<font color="black">[</font>str.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">4</font><font color="black">]</font>;
    glDisable<font color="black">(</font>GL_DEPTH_TEST<font color="black">)</font>;
    glEnable<font color="black">(</font>GL_BLEND<font color="black">)</font>;
    glBlendFunc<font color="black">(</font>GL_SRC_COLOR,GL_ONE_MINUS_SRC_COLOR<font color="black">)</font>;   
    UseTexture<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>page<font color="black">-</font><font color="black">&#62;</font>tex,<font color="maroon">0</font><font color="black">)</font>;  
    glEnable<font color="black">(</font>GL_TEXTURE_2D<font color="black">)</font>;
    vec2 curPos<font color="black">=</font>pos;    
    FT_Long useKerning <font color="black">=</font> FT_HAS_KERNING<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>fontImpl<font color="black">-</font><font color="black">&#62;</font>face<font color="black">)</font>;
    FT_UInt previous <font color="black">=</font> <font color="maroon">0</font>; 
    <font color="blue">for</font> <font color="black">(</font>string<font color="black">:</font><font color="black">:</font>const_iterator i<font color="black">=</font>str.begin<font color="black">(</font><font color="black">)</font>;i<font color="black">!</font><font color="black">=</font>str.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">char</font> c<font color="black">=</font><font color="black">*</font>i;
        <font color="blue">if</font> <font color="black">(</font>c<font color="black">=</font><font color="black">=</font><font color="maroon">32</font><font color="black">)</font>
        <font color="black">{</font>
            curPos.x<font color="black">+</font><font color="black">=</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.advance;
            <font color="blue">continue</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size<font color="black">!</font><font color="black">=</font>vec2<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>

            FT_UInt glyphIndex <font color="black">=</font> FT_Get_Char_Index<font color="black">(</font> font<font color="black">-</font><font color="black">&#62;</font>fontImpl<font color="black">-</font><font color="black">&#62;</font>face, c <font color="black">)</font>; 
            <font color="green">/* retrieve kerning distance and move pen position */</font>  
            <font color="blue">if</font> <font color="black">(</font> useKerning <font color="black">&</font><font color="black">&</font> previous <font color="black">&</font><font color="black">&</font> glyphIndex <font color="black">)</font> 
            <font color="black">{</font> 
                FT_Vector delta; 
                FT_Get_Kerning<font color="black">(</font> font<font color="black">-</font><font color="black">&#62;</font>fontImpl<font color="black">-</font><font color="black">&#62;</font>face, previous, glyphIndex, FT_KERNING_DEFAULT, <font color="black">&</font>delta <font color="black">)</font>; 
                curPos.x <font color="black">+</font><font color="black">=</font> delta.x <font color="black">&#62;</font><font color="black">&#62;</font> <font color="maroon">6</font>; 
            <font color="black">}</font> 
            vBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.x<font color="black">+</font>curPos.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.y<font color="black">+</font>curPos.y<font color="black">)</font>;
            vBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.x<font color="black">+</font>curPos.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.y<font color="black">+</font>curPos.y<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.y<font color="black">)</font>;
            vBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.x<font color="black">+</font>curPos.x<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.y<font color="black">+</font>curPos.y<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.y<font color="black">)</font>;
            vBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">3</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.x<font color="black">+</font>curPos.x<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.bitmapOffset.y<font color="black">+</font>curPos.y<font color="black">)</font>;
            uvBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.y<font color="black">)</font>;
            uvBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.x,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.y<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.y<font color="black">/</font><font color="maroon">512</font>.0f<font color="black">)</font>;
            uvBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.x<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.x<font color="black">/</font><font color="maroon">512</font>.0f,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.y<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.y<font color="black">/</font><font color="maroon">512</font>.0f<font color="black">)</font>;
            uvBuffer<font color="black">[</font>numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">+</font><font color="maroon">3</font><font color="black">]</font><font color="black">=</font>vec2<font color="black">(</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.x<font color="black">+</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.size.x<font color="black">/</font><font color="maroon">512</font>.0f,font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.uv.y<font color="black">)</font>;
            numQuads<font color="black">+</font><font color="black">+</font>;
            curPos.x<font color="black">+</font><font color="black">=</font>font<font color="black">-</font><font color="black">&#62;</font>glyph<font color="black">[</font>c<font color="black">]</font>.advance;
            previous<font color="black">=</font>glyphIndex;
        <font color="black">}</font>       
    <font color="black">}</font>   
    vb.LoadData<font color="black">(</font>vBuffer,numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">*</font><font color="maroon">2</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>,STREAM<font color="black">)</font>;
    uvb.LoadData<font color="black">(</font>uvBuffer,numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">*</font><font color="maroon">2</font><font color="black">*</font><font color="blue">sizeof</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>,STREAM<font color="black">)</font>;
    uvb.SetTexCoordStream<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>;
    vb.SetVertexStream<font color="black">(</font><font color="maroon">2</font><font color="black">)</font>;
    RenderStream<font color="black">(</font>QUADS,numQuads<font color="black">*</font><font color="maroon">4</font><font color="black">)</font>;
    glDisable<font color="black">(</font>GL_BLEND<font color="black">)</font>;
    glDisable<font color="black">(</font>GL_TEXTURE_2D<font color="black">)</font>;
    glEnable<font color="black">(</font>GL_DEPTH_TEST<font color="black">)</font>;    
    <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> vBuffer;
    <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> uvBuffer;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>RenderIndexStream<font color="black">(</font>RenderMode mode,DWORD count<font color="black">)</font>
<font color="black">{</font>
    GLenum glmode;
    <font color="blue">switch</font> <font color="black">(</font>mode<font color="black">)</font>
    <font color="black">{</font>
    <font color="blue">case</font> POINTS<font color="black">:</font>
        glmode<font color="black">=</font>GL_POINTS;
        <font color="blue">break</font>;
    <font color="blue">case</font> LINES<font color="black">:</font>
        glmode<font color="black">=</font>GL_LINES;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLES<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLES;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLE_STRIP<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLE_STRIP;
        <font color="blue">break</font>;
    <font color="blue">case</font> QUADS<font color="black">:</font>
        glmode<font color="black">=</font>GL_QUADS;
        <font color="blue">break</font>;
    <font color="blue">case</font> LINE_LOOP<font color="black">:</font>
        glmode<font color="black">=</font>GL_LINE_LOOP;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLE_FAN<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLE_FAN;
        <font color="blue">break</font>;
    <font color="black">}</font>   
    glDrawElements<font color="black">(</font>glmode,count,GL_UNSIGNED_INT,<font color="maroon">0</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>RenderStream<font color="black">(</font>RenderMode mode,DWORD count<font color="black">)</font>
<font color="black">{</font>
    GLenum glmode;
    <font color="blue">switch</font> <font color="black">(</font>mode<font color="black">)</font>
    <font color="black">{</font>
    <font color="blue">case</font> POINTS<font color="black">:</font>
        glmode<font color="black">=</font>GL_POINTS;
        <font color="blue">break</font>;
    <font color="blue">case</font> LINES<font color="black">:</font>
        glmode<font color="black">=</font>GL_LINES;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLES<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLES;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLE_STRIP<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLE_STRIP;
        <font color="blue">break</font>;
    <font color="blue">case</font> QUADS<font color="black">:</font>
        glmode<font color="black">=</font>GL_QUADS;
        <font color="blue">break</font>;
    <font color="blue">case</font> LINE_LOOP<font color="black">:</font>
        glmode<font color="black">=</font>GL_LINE_LOOP;
        <font color="blue">break</font>;
    <font color="blue">case</font> TRIANGLE_FAN<font color="black">:</font>
        glmode<font color="black">=</font>GL_TRIANGLE_FAN;
        <font color="blue">break</font>;
    <font color="black">}</font>   
    glDrawArrays<font color="black">(</font>glmode,<font color="maroon">0</font>,count<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>UseProgram<font color="black">(</font><font color="blue">const</font> Program <font color="black">&</font>program<font color="black">)</font>
<font color="black">{</font>
    glUseProgram<font color="black">(</font>program.id<font color="black">)</font>;   
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>UseMaterial<font color="black">(</font><font color="blue">const</font> Material <font color="black">&</font>material<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">float</font> ambient<font color="black">[</font><font color="black">]</font><font color="black">=</font><font color="black">{</font>material.ambient.x,material.ambient.y,material.ambient.z,<font color="maroon">1</font>.0f<font color="black">}</font>;
    <font color="blue">float</font> diffuse<font color="black">[</font><font color="black">]</font><font color="black">=</font><font color="black">{</font>material.diffuse.x,material.diffuse.y,material.diffuse.z,<font color="maroon">1</font>.0f<font color="black">}</font>;
    <font color="blue">float</font> specular<font color="black">[</font><font color="black">]</font><font color="black">=</font><font color="black">{</font>material.specular.x,material.specular.y,material.specular.z,<font color="maroon">1</font>.0f<font color="black">}</font>;            
    glMaterialfv<font color="black">(</font>GL_FRONT,GL_AMBIENT,ambient<font color="black">)</font>;
    glMaterialfv<font color="black">(</font>GL_FRONT,GL_DIFFUSE,diffuse<font color="black">)</font>;
    glMaterialfv<font color="black">(</font>GL_FRONT,GL_SPECULAR,specular<font color="black">)</font>;
    glMaterialf<font color="black">(</font>GL_FRONT,GL_SHININESS,material.shininess<font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>MAX_TEXTURES;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>   
        <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>material.texture<font color="black">[</font>i<font color="black">]</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>material.texture<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>IsValid<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            UseTexture<font color="black">(</font>material.texture<font color="black">[</font>i<font color="black">]</font>,i<font color="black">)</font>;
            glEnable<font color="black">(</font>GL_TEXTURE_2D<font color="black">)</font>;            
        <font color="black">}</font>
        <font color="blue">else</font>
        <font color="black">{</font>
            glActiveTexture<font color="black">(</font>GL_TEXTURE0<font color="black">+</font>i<font color="black">)</font>;
            glDisable<font color="black">(</font>GL_TEXTURE_2D<font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>

    <font color="blue">if</font> <font color="black">(</font>material.program.IsValid<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        UseProgram<font color="black">(</font>material.program<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SetPerspectiveProjection<font color="black">(</font><font color="blue">float</font> fov,<font color="blue">float</font> zNear,<font color="blue">float</font> zFar<font color="black">)</font>
<font color="black">{</font>
    GLint viewport<font color="black">[</font><font color="maroon">4</font><font color="black">]</font>;
    glGetIntegerv<font color="black">(</font>GL_VIEWPORT,viewport<font color="black">)</font>;
    mat4 p;
    p.GeneratePerspective<font color="black">(</font>fov,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>viewport<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">/</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>viewport<font color="black">[</font><font color="maroon">3</font><font color="black">]</font>,zNear,zFar<font color="black">)</font>;
    SetProjectionMatrix<font color="black">(</font>p<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Renderer<font color="black">:</font><font color="black">:</font>SetOrthographicProjection<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    GLint viewport<font color="black">[</font><font color="maroon">4</font><font color="black">]</font>;
    glGetIntegerv<font color="black">(</font>GL_VIEWPORT,viewport<font color="black">)</font>;
    mat4 p;
    p.GenerateOrthographic<font color="black">(</font><font color="maroon">0</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>viewport<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>viewport<font color="black">[</font><font color="maroon">3</font><font color="black">]</font>,<font color="maroon">0</font>,<font color="maroon">0</font>,<font color="maroon">1</font><font color="black">)</font>;
    SetProjectionMatrix<font color="black">(</font>p<font color="black">)</font>;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
