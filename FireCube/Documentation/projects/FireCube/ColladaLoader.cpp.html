<HTML>
<HEAD>
<TITLE>
ColladaLoader.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;Windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;gl/GL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;dae.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;dom/domCOLLADA.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"FireCube.h"</font>
<font color="blue">using</font> <font color="blue">namespace</font> FireCube;
<font color="blue">#include</font> <font color="maroon">"ModelLoaders.h"</font>


ColladaLoader<font color="black">:</font><font color="black">:</font>ColladaLoader<font color="black">(</font>ModelResource <font color="black">*</font>model<font color="black">)</font> <font color="black">:</font> model<font color="black">(</font>model<font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>

vec4 ColladaLoader<font color="black">:</font><font color="black">:</font>ReadColor<font color="black">(</font>daeElement <font color="black">*</font>elm<font color="black">)</font>
<font color="black">{</font>
    string data;
    vec4 ret<font color="black">(</font><font color="maroon">1</font>,<font color="maroon">1</font>,<font color="maroon">1</font>,<font color="maroon">1</font><font color="black">)</font>;
    daeElement <font color="black">*</font>colorElm<font color="black">=</font>elm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"color"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>colorElm<font color="black">)</font>
    <font color="black">{</font>
        colorElm<font color="black">-</font><font color="black">&#62;</font>getCharData<font color="black">(</font>data<font color="black">)</font>;
        istringstream iss<font color="black">(</font>data<font color="black">)</font>;
        iss <font color="black">&#62;</font><font color="black">&#62;</font> ret.x <font color="black">&#62;</font><font color="black">&#62;</font> ret.y <font color="black">&#62;</font><font color="black">&#62;</font> ret.z <font color="black">&#62;</font><font color="black">&#62;</font> ret.w;
    <font color="black">}</font>
    <font color="blue">return</font> ret;
<font color="black">}</font>
<font color="blue">bool</font> ColladaLoader<font color="black">:</font><font color="black">:</font>ReadTexture<font color="black">(</font>daeElement <font color="black">*</font>elm,map<font color="black">&#60;</font>string,pair<font color="black">&#60;</font>string,DWORD<font color="black">&#62;</font><font color="black">&#62;</font> <font color="black">&</font>vertexInput,string <font color="black">&</font>file,DWORD <font color="black">&</font>unit<font color="black">)</font>
<font color="black">{</font>
    daeElement <font color="black">*</font>textureElm<font color="black">=</font>elm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"texture"</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>textureElm<font color="black">)</font>
    <font color="black">{</font>
        string texture<font color="black">=</font>textureElm<font color="black">-</font><font color="black">&#62;</font>getAttribute<font color="black">(</font><font color="maroon">"texture"</font><font color="black">)</font>;
        unit<font color="black">=</font>vertexInput<font color="black">[</font>textureElm<font color="black">-</font><font color="black">&#62;</font>getAttribute<font color="black">(</font><font color="maroon">"texcoord"</font><font color="black">)</font><font color="black">]</font>.second;
        daeSidRef sidSampler<font color="black">(</font>texture, textureElm<font color="black">-</font><font color="black">&#62;</font>getAncestor<font color="black">(</font><font color="maroon">"effect"</font><font color="black">)</font><font color="black">)</font>;
        daeElement<font color="black">*</font> samplerElm <font color="black">=</font> sidSampler.resolve<font color="black">(</font><font color="black">)</font>.elt;
        <font color="blue">if</font> <font color="black">(</font>samplerElm<font color="black">)</font>
        <font color="black">{</font>           
            <font color="blue">if</font> <font color="black">(</font>samplerElm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>COMMON_NEWPARAM_TYPE<font color="black">)</font>
            <font color="black">{</font>           
                string srf;
                samplerElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"sampler2D"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"source"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getCharData<font color="black">(</font>srf<font color="black">)</font>;
                daeSidRef sidSurface<font color="black">(</font>srf,samplerElm<font color="black">-</font><font color="black">&#62;</font>getAncestor<font color="black">(</font><font color="maroon">"effect"</font><font color="black">)</font><font color="black">)</font>;
                daeElement <font color="black">*</font>surfaceElm<font color="black">=</font>sidSurface.resolve<font color="black">(</font><font color="black">)</font>.elt;
                <font color="blue">if</font> <font color="black">(</font>surfaceElm<font color="black">)</font>
                <font color="black">{</font>
                    string image;
                    surfaceElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"surface"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"init_from"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getCharData<font color="black">(</font>image<font color="black">)</font>;
                    file<font color="black">=</font>imageMap<font color="black">[</font>image<font color="black">]</font>;
                    <font color="blue">return</font> <font color="blue">true</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>samplerElm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>IMAGE<font color="black">)</font>
            <font color="black">{</font>
                domImage <font color="black">*</font>img<font color="black">=</font><font color="black">(</font>domImage<font color="black">*</font><font color="black">)</font>samplerElm;                
                string f<font color="black">=</font>img<font color="black">-</font><font color="black">&#62;</font>getInit_from<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.getOriginalURI<font color="black">(</font><font color="black">)</font>;  
                file<font color="black">=</font>f;
                <font color="blue">return</font> <font color="blue">true</font>;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>
Material ColladaLoader<font color="black">:</font><font color="black">:</font>LoadMaterial<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font>,map<font color="black">&#60;</font>string,pair<font color="black">&#60;</font>string,DWORD<font color="black">&#62;</font><font color="black">&#62;</font> <font color="black">&</font>vertexInput<font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>domMaterial<font color="black">*</font><font color="black">&#62;</font> materials<font color="black">=</font>colladaDom.getDatabase<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>typeLookup<font color="black">&#60;</font>domMaterial<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>; 
    <font color="blue">for</font> <font color="black">(</font>DWORD matIndex<font color="black">=</font><font color="maroon">0</font>;matIndex<font color="black">&#60;</font>materials.size<font color="black">(</font><font color="black">)</font>;matIndex<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        domMaterial <font color="black">*</font>mat<font color="black">=</font>materials<font color="black">[</font>matIndex<font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font>mat<font color="black">-</font><font color="black">&#62;</font>getID<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="blue">name</font><font color="black">)</font>
        <font color="black">{</font>   
            Material curMat<font color="black">=</font>Material<font color="black">(</font><font color="blue">new</font> MaterialResource<font color="black">)</font>;     
            curMat<font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font>mat<font color="black">-</font><font color="black">&#62;</font>getName<font color="black">(</font><font color="black">)</font>;            

            daeElement <font color="black">*</font>elm<font color="black">=</font>mat<font color="black">-</font><font color="black">&#62;</font>getInstance_effect<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getUrl<font color="black">(</font><font color="black">)</font>.getElement<font color="black">(</font><font color="black">)</font>;
            domEffect <font color="black">*</font>effect<font color="black">=</font><font color="black">(</font>domEffect<font color="black">*</font><font color="black">)</font>elm;
            domFx_profile_abstract_Array <font color="black">&</font>fxaa<font color="black">=</font>effect<font color="black">-</font><font color="black">&#62;</font>getFx_profile_abstract_array<font color="black">(</font><font color="black">)</font>;      
            <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>fxaa.getCount<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                domFx_profile_abstractRef pa<font color="black">=</font>fxaa.get<font color="black">(</font>i<font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font>strcmp<font color="black">(</font>pa<font color="black">-</font><font color="black">&#62;</font>getTypeName<font color="black">(</font><font color="black">)</font>,<font color="maroon">"profile_COMMON"</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
                <font color="black">{</font>               
                    daeElement <font color="black">*</font>techniqueElm<font color="black">=</font>pa<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"technique"</font><font color="black">)</font>;
                    daeElement <font color="black">*</font>shadingElm<font color="black">=</font>techniqueElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"phong"</font><font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>shadingElm<font color="black">)</font> 
                        shadingElm<font color="black">=</font>techniqueElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"blinn"</font><font color="black">)</font>;

                    <font color="blue">if</font> <font color="black">(</font>shadingElm<font color="black">)</font>
                    <font color="black">{</font>               
                        string data;
                        string file;
                        DWORD unit;

                        curMat<font color="black">-</font><font color="black">&#62;</font>ambient<font color="black">=</font>ReadColor<font color="black">(</font>shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"ambient"</font><font color="black">)</font><font color="black">)</font>;
                        curMat<font color="black">-</font><font color="black">&#62;</font>diffuse<font color="black">=</font>ReadColor<font color="black">(</font>shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"diffuse"</font><font color="black">)</font><font color="black">)</font>;
                        curMat<font color="black">-</font><font color="black">&#62;</font>specular<font color="black">=</font>ReadColor<font color="black">(</font>shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"specular"</font><font color="black">)</font><font color="black">)</font>;
                        domElement <font color="black">*</font>transparency<font color="black">=</font>shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"transparency"</font><font color="black">)</font>;
                        <font color="blue">if</font> <font color="black">(</font>transparency<font color="black">)</font>
                        <font color="black">{</font>
                            domElement <font color="black">*</font>f<font color="black">=</font>transparency<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"float"</font><font color="black">)</font>;
                            <font color="blue">if</font> <font color="black">(</font>f<font color="black">)</font>
                            <font color="black">{</font>                           
                                string data;
                                f<font color="black">-</font><font color="black">&#62;</font>getCharData<font color="black">(</font>data<font color="black">)</font>;
                                istringstream iss<font color="black">(</font>data<font color="black">)</font>;
                                <font color="blue">float</font> v;
                                iss <font color="black">&#62;</font><font color="black">&#62;</font> v;
                                curMat<font color="black">-</font><font color="black">&#62;</font>diffuse.w<font color="black">=</font>v;
                            <font color="black">}</font>
                        <font color="black">}</font>
                        <font color="blue">if</font> <font color="black">(</font>ReadTexture<font color="black">(</font>shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"diffuse"</font><font color="black">)</font>,vertexInput,file,unit<font color="black">)</font><font color="black">)</font>
                        <font color="black">{</font>
                            string<font color="black">:</font><font color="black">:</font>size_type i<font color="black">=</font>file.find<font color="black">(</font><font color="maroon">"file://"</font><font color="black">)</font>;
                            <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
                            <font color="black">{</font>
                                file.erase<font color="black">(</font>i,i<font color="black">+</font><font color="maroon">7</font><font color="black">)</font>;
                            <font color="black">}</font>
                            i<font color="black">=</font>file.find<font color="black">(</font><font color="maroon">"%20"</font><font color="black">)</font>;
                            <font color="blue">while</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
                            <font color="black">{</font>
                                file.replace<font color="black">(</font>i,<font color="maroon">3</font>,<font color="maroon">" "</font><font color="black">)</font>;                              
                                i<font color="black">=</font>file.find<font color="black">(</font><font color="maroon">"%20"</font><font color="black">)</font>;
                            <font color="black">}</font>
                            
                            curMat<font color="black">-</font><font color="black">&#62;</font>texture<font color="black">[</font>unit<font color="black">]</font><font color="black">=</font>Renderer<font color="black">:</font><font color="black">:</font>GetTextureManager<font color="black">(</font><font color="black">)</font>.Create<font color="black">(</font>file<font color="black">)</font>;
                        <font color="black">}</font>                       
                        shadingElm<font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"shininess"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getChild<font color="black">(</font><font color="maroon">"float"</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getCharData<font color="black">(</font>data<font color="black">)</font>;                
                        istringstream shss<font color="black">(</font>data<font color="black">)</font>;
                        shss <font color="black">&#62;</font><font color="black">&#62;</font> curMat<font color="black">-</font><font color="black">&#62;</font>shininess;
                    <font color="black">}</font>                   
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">return</font> curMat;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> Material<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> ColladaLoader<font color="black">:</font><font color="black">:</font>LoadMesh<font color="black">(</font>string <font color="black">&</font>id,mat4 transform,map<font color="black">&#60;</font>string,string<font color="black">&#62;</font> <font color="black">&</font>materialMap,map<font color="black">&#60;</font>string,pair<font color="black">&#60;</font>string,DWORD<font color="black">&#62;</font><font color="black">&#62;</font> <font color="black">&</font>vertexInput<font color="black">)</font>
<font color="black">{</font>   
    map<font color="black">&#60;</font>string,Source<font color="black">&#62;</font> sourcesArray;
    map<font color="black">&#60;</font>string,vector<font color="black">&#60;</font>vec4<font color="black">&#62;</font><font color="black">&#62;</font> vecArray;  
    vector<font color="black">&#60;</font>domGeometry <font color="black">*</font><font color="black">&#62;</font> geometries<font color="black">=</font>colladaDom.getDatabase<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>typeLookup<font color="black">&#60;</font>domGeometry<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>DWORD geometryIndex<font color="black">=</font><font color="maroon">0</font>;geometryIndex<font color="black">&#60;</font>geometries.size<font color="black">(</font><font color="black">)</font>;geometryIndex<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>       
        domGeometry <font color="black">*</font>geometry<font color="black">=</font>geometries<font color="black">[</font>geometryIndex<font color="black">]</font>;        
        <font color="blue">if</font> <font color="black">(</font>geometry<font color="black">-</font><font color="black">&#62;</font>getID<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font>id<font color="black">)</font>
            <font color="blue">continue</font>;       
        model<font color="black">-</font><font color="black">&#62;</font>object.push_back<font color="black">(</font>Object<font color="black">(</font><font color="black">)</font><font color="black">)</font>;              
        model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.<font color="blue">name</font><font color="black">=</font>geometry<font color="black">-</font><font color="black">&#62;</font>getID<font color="black">(</font><font color="black">)</font>;

        domMeshRef thisMesh<font color="black">=</font>geometry<font color="black">-</font><font color="black">&#62;</font>getMesh<font color="black">(</font><font color="black">)</font>;        

        <font color="green">// Read all sources for this mesh.</font>
        domSource_Array <font color="black">&</font>sourceArray<font color="black">=</font>thisMesh<font color="black">-</font><font color="black">&#62;</font>getSource_array<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>DWORD sourceIndex<font color="black">=</font><font color="maroon">0</font>;sourceIndex<font color="black">&#60;</font>sourceArray.getCount<font color="black">(</font><font color="black">)</font>;sourceIndex<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>           
            domSourceRef source<font color="black">=</font>sourceArray.get<font color="black">(</font>sourceIndex<font color="black">)</font>;
            sourcesArray<font color="black">[</font>source<font color="black">-</font><font color="black">&#62;</font>getID<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>ReadSource<font color="black">(</font>source<font color="black">)</font>;
        <font color="black">}</font>

        <font color="green">// Read vertices.</font>
        domVerticesRef vert<font color="black">=</font>thisMesh<font color="black">-</font><font color="black">&#62;</font>getVertices<font color="black">(</font><font color="black">)</font>;
        domInputLocal_Array <font color="black">&</font>v<font color="black">=</font>vert<font color="black">-</font><font color="black">&#62;</font>getInput_array<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>v.getCount<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font>  <font color="black">(</font>strcmp<font color="black">(</font>v<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>getSemantic<font color="black">(</font><font color="black">)</font>,<font color="maroon">"POSITION"</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
            <font color="black">{</font>
                vecArray<font color="black">[</font>vert<font color="black">-</font><font color="black">&#62;</font>getId<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>SourceToVecArray<font color="black">(</font>sourcesArray<font color="black">[</font>v<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="green">// Read triangles lists.</font>
        domTriangles_Array <font color="black">&</font>triArray<font color="black">=</font>thisMesh<font color="black">-</font><font color="black">&#62;</font>getTriangles_array<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>DWORD triArrayIndex<font color="black">=</font><font color="maroon">0</font>;triArrayIndex<font color="black">&#60;</font>triArray.getCount<font color="black">(</font><font color="black">)</font>;triArrayIndex<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            domTrianglesRef tris<font color="black">=</font>triArray.get<font color="black">(</font>triArrayIndex<font color="black">)</font>;
            model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.mesh.push_back<font color="black">(</font>Mesh<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            <font color="green">// Load the material.</font>
            Material mat<font color="black">=</font>LoadMaterial<font color="black">(</font>materialMap<font color="black">[</font>tris<font color="black">-</font><font color="black">&#62;</font>getMaterial<font color="black">(</font><font color="black">)</font><font color="black">]</font>,vertexInput<font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font>mat<font color="black">)</font>
            <font color="black">{</font>
                model<font color="black">-</font><font color="black">&#62;</font>material.push_back<font color="black">(</font>mat<font color="black">)</font>;
                model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.mesh<font color="black">[</font>triArrayIndex<font color="black">]</font>.material<font color="black">=</font>mat;
            <font color="black">}</font>

            domPRef p<font color="black">=</font>tris<font color="black">-</font><font color="black">&#62;</font>getP<font color="black">(</font><font color="black">)</font>;
            domInputLocalOffset_Array <font color="black">&</font>tv<font color="black">=</font>tris<font color="black">-</font><font color="black">&#62;</font>getInput_array<font color="black">(</font><font color="black">)</font>;
            domListOfUInts <font color="black">&</font>pv<font color="black">=</font>p<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>;
            DWORD cc<font color="black">=</font><font color="maroon">0</font>;
            map<font color="black">&#60;</font>string,DWORD<font color="black">&#62;</font> deindexMap;
            DWORD v<font color="black">[</font><font color="maroon">3</font><font color="black">]</font>;
            <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>pv.getCount<font color="black">(</font><font color="black">)</font>;<font color="black">)</font>
            <font color="black">{</font>               
                DWORD highestOffset<font color="black">=</font><font color="maroon">0</font>;
                ostringstream vertexId;
                <font color="green">// Generate current vertex id based on its indices to the input buffers.</font>
                <font color="blue">for</font> <font color="black">(</font>DWORD cs<font color="black">=</font><font color="maroon">0</font>;cs<font color="black">&#60;</font>tv.getCount<font color="black">(</font><font color="black">)</font>;cs<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                <font color="black">{</font>
                    domInputLocalOffsetRef lo<font color="black">=</font>tv.get<font color="black">(</font>cs<font color="black">)</font>;
                    <font color="blue">if</font> <font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font><font color="black">&#62;</font>highestOffset<font color="black">)</font>
                        highestOffset<font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font>;
                    vertexId <font color="black">&#60;</font><font color="black">&#60;</font> <font color="black">(</font>DWORD<font color="black">)</font>pv<font color="black">[</font>i<font color="black">+</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font><font color="black">]</font>;
                    vertexId <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" "</font>;
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font>deindexMap.find<font color="black">(</font>vertexId.str<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>deindexMap.end<font color="black">(</font><font color="black">)</font><font color="black">)</font> <font color="green">// If it's a new vertex, read it.</font>
                <font color="black">{</font>               
                    <font color="blue">for</font> <font color="black">(</font>DWORD cs<font color="black">=</font><font color="maroon">0</font>;cs<font color="black">&#60;</font>tv.getCount<font color="black">(</font><font color="black">)</font>;cs<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                    <font color="black">{</font>
                        domInputLocalOffsetRef lo<font color="black">=</font>tv.get<font color="black">(</font>cs<font color="black">)</font>;                       
                        <font color="blue">if</font> <font color="black">(</font>strcmp<font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getSemantic<font color="black">(</font><font color="black">)</font>,<font color="maroon">"VERTEX"</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font> <font color="green">// Get position from previously read source.</font>
                        <font color="black">{</font>
                            vector<font color="black">&#60;</font>vec4<font color="black">&#62;</font> <font color="black">&</font>vve<font color="black">=</font>vecArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font>;
                            vec3 v0<font color="black">=</font>vve<font color="black">[</font><font color="black">(</font>DWORD<font color="black">)</font>pv<font color="black">[</font>i<font color="black">+</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">]</font>;
                            v0<font color="black">=</font>v0<font color="black">*</font>transform;
                            <font color="blue">if</font> <font color="black">(</font>upAxis<font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
                            <font color="black">{</font>
                                std<font color="black">:</font><font color="black">:</font>swap<font color="black">(</font>v0.x,v0.y<font color="black">)</font>;
                                v0.x<font color="black">*</font><font color="black">=</font><font color="maroon">-1</font>;
                            <font color="black">}</font>
                            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>upAxis<font color="black">=</font><font color="black">=</font><font color="maroon">2</font><font color="black">)</font>
                            <font color="black">{</font>
                                std<font color="black">:</font><font color="black">:</font>swap<font color="black">(</font>v0.y,v0.z<font color="black">)</font>;
                                v0.z<font color="black">*</font><font color="black">=</font><font color="maroon">-1</font>;
                            <font color="black">}</font>
                            model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex.push_back<font color="black">(</font>v0<font color="black">)</font>;             
                        <font color="black">}</font>
                        <font color="blue">if</font> <font color="black">(</font>strcmp<font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getSemantic<font color="black">(</font><font color="black">)</font>,<font color="maroon">"NORMAL"</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font> <font color="green">// Get normal from previously read source.</font>
                        <font color="black">{</font>                       
                            <font color="blue">if</font> <font color="black">(</font>vecArray.find<font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>vecArray.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
                            <font color="black">{</font>                           
                                vecArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>SourceToVecArray<font color="black">(</font>sourcesArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">)</font>;
                            <font color="black">}</font>                       
                            vec3 n<font color="black">=</font>vecArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">[</font><font color="black">(</font>DWORD<font color="black">)</font>pv<font color="black">[</font>i<font color="black">+</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">]</font>;
                            n<font color="black">=</font>n.TransformNormal<font color="black">(</font>transform<font color="black">)</font>;
                            <font color="blue">if</font> <font color="black">(</font>upAxis<font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
                            <font color="black">{</font>
                                std<font color="black">:</font><font color="black">:</font>swap<font color="black">(</font>n.x,n.y<font color="black">)</font>;
                                n.x<font color="black">*</font><font color="black">=</font><font color="maroon">-1</font>;
                            <font color="black">}</font>
                            <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>upAxis<font color="black">=</font><font color="black">=</font><font color="maroon">2</font><font color="black">)</font>
                            <font color="black">{</font>
                                std<font color="black">:</font><font color="black">:</font>swap<font color="black">(</font>n.y,n.z<font color="black">)</font>;
                                n.z<font color="black">*</font><font color="black">=</font><font color="maroon">-1</font>;
                            <font color="black">}</font>
                            n.Normalize<font color="black">(</font><font color="black">)</font>;
                            model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.normal.push_back<font color="black">(</font>n<font color="black">)</font>;
                        <font color="black">}</font>
                        <font color="blue">if</font> <font color="black">(</font>strcmp<font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getSemantic<font color="black">(</font><font color="black">)</font>,<font color="maroon">"TEXCOORD"</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font> <font color="green">// Get uv from previously read source.</font>
                        <font color="black">{</font>
                            <font color="blue">if</font> <font color="black">(</font>vecArray.find<font color="black">(</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>vecArray.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
                            <font color="black">{</font>                           
                                vecArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>SourceToVecArray<font color="black">(</font>sourcesArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">)</font>;
                            <font color="black">}</font>
                            DWORD unit<font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getSet<font color="black">(</font><font color="black">)</font>;
                            vec2 uv<font color="black">=</font>vecArray<font color="black">[</font>lo<font color="black">-</font><font color="black">&#62;</font>getSource<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">[</font><font color="black">(</font>DWORD<font color="black">)</font>pv<font color="black">[</font>i<font color="black">+</font><font color="black">(</font>DWORD<font color="black">)</font>lo<font color="black">-</font><font color="black">&#62;</font>getOffset<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">]</font>;
                            model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.uv<font color="black">[</font>unit<font color="black">]</font>.push_back<font color="black">(</font>vec2<font color="black">(</font>uv.x,<font color="maroon">1</font>.0f<font color="black">-</font>uv.y<font color="black">)</font><font color="black">)</font>;
                        <font color="black">}</font>                       
                    <font color="black">}</font>
                    v<font color="black">[</font>cc<font color="black">]</font><font color="black">=</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font>; <font color="green">// Remember this vertex index.</font>
                    deindexMap<font color="black">[</font>vertexId.str<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>v<font color="black">[</font>cc<font color="black">]</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                    v<font color="black">[</font>cc<font color="black">]</font><font color="black">=</font>deindexMap<font color="black">[</font>vertexId.str<font color="black">(</font><font color="black">)</font><font color="black">]</font>; <font color="green">// Already read this vertex, just get its index.</font>

                i<font color="black">+</font><font color="black">=</font>highestOffset<font color="black">+</font><font color="maroon">1</font>;
                cc<font color="black">+</font><font color="black">+</font>;
                <font color="blue">if</font> <font color="black">(</font>cc<font color="black">=</font><font color="black">=</font><font color="maroon">3</font><font color="black">)</font>
                <font color="black">{</font>
                    cc<font color="black">=</font><font color="maroon">0</font>;           
                    Face f;
                    f.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
                    f.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>;
                    f.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
                    vec3 faceNormal<font color="black">=</font>Cross<font color="black">(</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex<font color="black">[</font>f.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex<font color="black">[</font>f.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>,model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex<font color="black">[</font>f.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.vertex<font color="black">[</font>f.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font><font color="black">)</font>;
                    faceNormal.Normalize<font color="black">(</font><font color="black">)</font>;
                    f.normal<font color="black">=</font>faceNormal;
                    model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.mesh<font color="black">[</font>triArrayIndex<font color="black">]</font>.face.push_back<font color="black">(</font>f<font color="black">)</font>;
                    model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.face.push_back<font color="black">(</font>f<font color="black">)</font>;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>       
    <font color="black">}</font>           
<font color="black">}</font>
<font color="blue">void</font> ColladaLoader<font color="black">:</font><font color="black">:</font>LoadNodes<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>domNode<font color="black">*</font><font color="black">&#62;</font> nodes <font color="black">=</font> colladaDom.getDatabase<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>typeLookup<font color="black">&#60;</font>domNode<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>nodes.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        mat4 transform;
        domNode <font color="black">*</font>curNode<font color="black">=</font>nodes<font color="black">[</font>i<font color="black">]</font>;      
        transform<font color="black">=</font>ReadTransformation<font color="black">(</font>curNode<font color="black">)</font>;
        domInstance_geometry_Array <font color="black">&</font>iga<font color="black">=</font>curNode<font color="black">-</font><font color="black">&#62;</font>getInstance_geometry_array<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>DWORD j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>iga.getCount<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            map<font color="black">&#60;</font>string,string<font color="black">&#62;</font> materialMap;
            map<font color="black">&#60;</font>string,pair<font color="black">&#60;</font>string,DWORD<font color="black">&#62;</font><font color="black">&#62;</font> vertexInput;
            domInstance_geometryRef ig<font color="black">=</font>iga.get<font color="black">(</font>j<font color="black">)</font>;
            domInstance_material_Array <font color="black">&</font>ima<font color="black">=</font>ig<font color="black">-</font><font color="black">&#62;</font>getBind_material<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getTechnique_common<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getInstance_material_array<font color="black">(</font><font color="black">)</font>;
            <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>ima.getCount<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                domInstance_materialRef im<font color="black">=</font>ima.get<font color="black">(</font>k<font color="black">)</font>;
                domInstance_material<font color="black">:</font><font color="black">:</font>domBind_vertex_input_Array <font color="black">&</font>via <font color="black">=</font> im<font color="black">-</font><font color="black">&#62;</font>getBind_vertex_input_array<font color="black">(</font><font color="black">)</font>;
                <font color="blue">for</font> <font color="black">(</font>DWORD l<font color="black">=</font><font color="maroon">0</font>;l<font color="black">&#60;</font>via.getCount<font color="black">(</font><font color="black">)</font>;l<font color="black">+</font><font color="black">+</font><font color="black">)</font>                
                    vertexInput<font color="black">[</font>via.get<font color="black">(</font>l<font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getSemantic<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>make_pair<font color="black">&#60;</font>string,<font color="blue">unsigned</font> <font color="blue">int</font><font color="black">&#62;</font><font color="black">(</font>via.get<font color="black">(</font>l<font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getInput_semantic<font color="black">(</font><font color="black">)</font>,<font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">)</font>via.get<font color="black">(</font>l<font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getInput_set<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
                materialMap<font color="black">[</font>im<font color="black">-</font><font color="black">&#62;</font>getSymbol<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>string<font color="black">(</font>im<font color="black">-</font><font color="black">&#62;</font>getTarget<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            <font color="black">}</font>
            LoadMesh<font color="black">(</font>string<font color="black">(</font>ig<font color="black">-</font><font color="black">&#62;</font>getUrl<font color="black">(</font><font color="black">)</font>.getFragment<font color="black">(</font><font color="black">)</font><font color="black">)</font>,transform,materialMap,vertexInput<font color="black">)</font>;     
        <font color="black">}</font>
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">bool</font> ColladaLoader<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    daeInt result <font color="black">=</font> colladaDom.load<font color="black">(</font>filename.c_str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;

    <font color="blue">if</font><font color="black">(</font>result <font color="black">!</font><font color="black">=</font> DAE_OK<font color="black">)</font> <font color="black">{</font>      

        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="black">}</font>
    vector<font color="black">&#60;</font>domAsset<font color="black">*</font><font color="black">&#62;</font> assets <font color="black">=</font> colladaDom.getDatabase<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>typeLookup<font color="black">&#60;</font>domAsset<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>assets.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        domAsset <font color="black">*</font>asset<font color="black">=</font>assets<font color="black">[</font>i<font color="black">]</font>;
        domAsset<font color="black">:</font><font color="black">:</font>domUp_axisRef up<font color="black">=</font>asset<font color="black">-</font><font color="black">&#62;</font>getUp_axis<font color="black">(</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>up<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>UPAXISTYPE_X_UP<font color="black">)</font>
            upAxis<font color="black">=</font><font color="maroon">0</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>up<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>UPAXISTYPE_Y_UP<font color="black">)</font>
            upAxis<font color="black">=</font><font color="maroon">1</font>;
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>up<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>UPAXISTYPE_Z_UP<font color="black">)</font>
            upAxis<font color="black">=</font><font color="maroon">2</font>;
        domAsset<font color="black">:</font><font color="black">:</font>domUnitRef unit<font color="black">=</font>asset<font color="black">-</font><font color="black">&#62;</font>getUnit<font color="black">(</font><font color="black">)</font>;
        scale<font color="black">=</font>vec3<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>unit<font color="black">-</font><font color="black">&#62;</font>getMeter<font color="black">(</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>unit<font color="black">-</font><font color="black">&#62;</font>getMeter<font color="black">(</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>unit<font color="black">-</font><font color="black">&#62;</font>getMeter<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
    LoadImageMap<font color="black">(</font><font color="black">)</font>; 
    LoadNodes<font color="black">(</font><font color="black">)</font>;


    model<font color="black">-</font><font color="black">&#62;</font>UpdateBuffers<font color="black">(</font><font color="black">)</font>;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
ColladaLoader<font color="black">:</font><font color="black">:</font>Source ColladaLoader<font color="black">:</font><font color="black">:</font>ReadSource<font color="black">(</font>domSourceRef source<font color="black">)</font>
<font color="black">{</font>
    Source ret;
    ret.stride<font color="black">=</font><font color="black">(</font><font color="blue">int</font><font color="black">)</font>source<font color="black">-</font><font color="black">&#62;</font>getTechnique_common<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getAccessor<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getStride<font color="black">(</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>source<font color="black">-</font><font color="black">&#62;</font>getFloat_array<font color="black">(</font><font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>   
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> iv<font color="black">=</font><font color="maroon">0</font>;iv<font color="black">&#60;</font>source<font color="black">-</font><font color="black">&#62;</font>getFloat_array<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.getCount<font color="black">(</font><font color="black">)</font>;iv<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            ret.floatArray.push_back<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>source<font color="black">-</font><font color="black">&#62;</font>getFloat_array<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font><font color="black">[</font>iv<font color="black">]</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>   
    <font color="blue">return</font> ret;
<font color="black">}</font>
Material ColladaLoader<font color="black">:</font><font color="black">:</font>GetMaterialByName<font color="black">(</font>string <font color="black">&</font><font color="blue">name</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>model<font color="black">-</font><font color="black">&#62;</font>material.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font>model<font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font><font color="black">=</font><font color="blue">name</font><font color="black">)</font>
            <font color="blue">return</font> model<font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font>i<font color="black">]</font>;
    <font color="black">}</font>
    <font color="blue">return</font> Material<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
vector<font color="black">&#60;</font>vec4<font color="black">&#62;</font> ColladaLoader<font color="black">:</font><font color="black">:</font>SourceToVecArray<font color="black">(</font><font color="blue">const</font> Source <font color="black">&</font>source<font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>vec4<font color="black">&#62;</font> ret;   
    vec4 v;
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>source.floatArray.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">=</font>source.stride<font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">for</font> <font color="black">(</font>DWORD j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>source.stride;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font>j<font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
                v.x<font color="black">=</font>source.floatArray<font color="black">[</font>i<font color="black">+</font>j<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font>j<font color="black">=</font><font color="black">=</font><font color="maroon">1</font><font color="black">)</font>
                v.y<font color="black">=</font>source.floatArray<font color="black">[</font>i<font color="black">+</font>j<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font>j<font color="black">=</font><font color="black">=</font><font color="maroon">2</font><font color="black">)</font>
                v.z<font color="black">=</font>source.floatArray<font color="black">[</font>i<font color="black">+</font>j<font color="black">]</font>;
            <font color="blue">if</font> <font color="black">(</font>j<font color="black">=</font><font color="black">=</font><font color="maroon">3</font><font color="black">)</font>
                v.w<font color="black">=</font>source.floatArray<font color="black">[</font>i<font color="black">+</font>j<font color="black">]</font>;
        <font color="black">}</font>
        ret.push_back<font color="black">(</font>v<font color="black">)</font>;
    <font color="black">}</font>       
    <font color="blue">return</font> ret;
<font color="black">}</font>
<font color="blue">void</font> ColladaLoader<font color="black">:</font><font color="black">:</font>LoadImageMap<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>domImage<font color="black">*</font><font color="black">&#62;</font> images <font color="black">=</font> colladaDom.getDatabase<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>typeLookup<font color="black">&#60;</font>domImage<font color="black">&#62;</font><font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>images.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        domImage <font color="black">*</font>curImage<font color="black">=</font>images<font color="black">[</font>i<font color="black">]</font>;
        string file<font color="black">=</font>curImage<font color="black">-</font><font color="black">&#62;</font>getInit_from<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.getOriginalURI<font color="black">(</font><font color="black">)</font>;
        imageMap<font color="black">[</font>curImage<font color="black">-</font><font color="black">&#62;</font>getId<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>file;
    <font color="black">}</font>
<font color="black">}</font>
mat4 ColladaLoader<font color="black">:</font><font color="black">:</font>ReadTransformation<font color="black">(</font>domNode <font color="black">*</font>node<font color="black">)</font>
<font color="black">{</font>
    mat4 transform;
    daeTArray<font color="black">&#60;</font>daeSmartRef<font color="black">&#60;</font>daeElement<font color="black">&#62;</font><font color="black">&#62;</font> children;
    node<font color="black">-</font><font color="black">&#62;</font>getChildren<font color="black">(</font>children<font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>children.getCount<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        daeSmartRef<font color="black">&#60;</font>domElement<font color="black">&#62;</font> elm<font color="black">=</font>children.get<font color="black">(</font>i<font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>elm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>MATRIX<font color="black">)</font>
        <font color="black">{</font>
            mat4 t;
            domMatrix <font color="black">*</font>mat<font color="black">=</font><font color="black">(</font>domMatrix<font color="black">*</font><font color="black">)</font>elm.cast<font color="black">(</font><font color="black">)</font>;
            <font color="blue">for</font> <font color="black">(</font>DWORD j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font><font color="maroon">16</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                t.m<font color="black">[</font>j<font color="black">]</font><font color="black">=</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>mat<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font>j<font color="black">)</font>;
            t.Transpose<font color="black">(</font><font color="black">)</font>;
            transform<font color="black">*</font><font color="black">=</font>t;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>elm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>TRANSLATE<font color="black">)</font>
        <font color="black">{</font>
            domTranslate <font color="black">*</font>t<font color="black">=</font><font color="black">(</font>domTranslate<font color="black">*</font><font color="black">)</font>elm.cast<font color="black">(</font><font color="black">)</font>;          
            vec3 tr<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>t<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>t<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">1</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>t<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">2</font><font color="black">)</font><font color="black">)</font>;
            mat4 trans;
            trans.Translate<font color="black">(</font>tr<font color="black">)</font>;
            transform<font color="black">*</font><font color="black">=</font>trans;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>elm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>ROTATE<font color="black">)</font>
        <font color="black">{</font>
            domRotate <font color="black">*</font>r<font color="black">=</font><font color="black">(</font>domRotate<font color="black">*</font><font color="black">)</font>elm.cast<font color="black">(</font><font color="black">)</font>;            
            vec4 rt<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>r<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>r<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">1</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>r<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">2</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">-</font>r<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">3</font><font color="black">)</font><font color="black">/</font><font color="maroon">180</font>.0f <font color="black">*</font> PI<font color="black">)</font><font color="black">)</font>;
            mat4 rot;
            rot.Rotate<font color="black">(</font>rt<font color="black">)</font>;
            transform<font color="black">*</font><font color="black">=</font>rot;
        <font color="black">}</font>
        <font color="blue">else</font> <font color="blue">if</font> <font color="black">(</font>elm<font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>SCALE<font color="black">)</font>
        <font color="black">{</font>
            domScale <font color="black">*</font>s<font color="black">=</font><font color="black">(</font>domScale<font color="black">*</font><font color="black">)</font>elm.cast<font color="black">(</font><font color="black">)</font>;          
            vec3 sr<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>s<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>s<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">1</font><font color="black">)</font>,<font color="black">(</font><font color="blue">float</font><font color="black">)</font>s<font color="black">-</font><font color="black">&#62;</font>getValue<font color="black">(</font><font color="black">)</font>.get<font color="black">(</font><font color="maroon">2</font><font color="black">)</font><font color="black">)</font>;
            mat4 scale;
            scale.Scale<font color="black">(</font>sr.x,sr.y,sr.z<font color="black">)</font>;
            transform<font color="black">*</font><font color="black">=</font>scale;
        <font color="black">}</font>
    <font color="black">}</font>   
        
    <font color="blue">if</font> <font color="black">(</font>node<font color="black">-</font><font color="black">&#62;</font>getParent<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">if</font> <font color="black">(</font>node<font color="black">-</font><font color="black">&#62;</font>getParent<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>getElementType<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font>COLLADA_TYPE<font color="black">:</font><font color="black">:</font>NODE<font color="black">)</font>        
            <font color="blue">return</font> ReadTransformation<font color="black">(</font><font color="black">(</font>domNode<font color="black">*</font><font color="black">)</font>node<font color="black">-</font><font color="black">&#62;</font>getParent<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">*</font>transform;
    <font color="blue">return</font> transform;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
