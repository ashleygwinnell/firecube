<HTML>
<HEAD>
<TITLE>
Application.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;streambuf&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;io.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fcntl.h&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;Windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;ft2build.h&#62;</font>
<font color="blue">#include</font> FT_FREETYPE_H

<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Geometry.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"RenderQueue.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;


<font color="blue">extern</font> <font color="blue">void</font> InitializeRenderer<font color="black">(</font><font color="black">)</font>;
<font color="blue">extern</font> <font color="blue">void</font> DestroyRenderer<font color="black">(</font><font color="black">)</font>;
<font color="blue">extern</font> FT_Library freeTypeLibrary;

std<font color="black">:</font><font color="black">:</font>vector<font color="black">&#60;</font>std<font color="black">:</font><font color="black">:</font>string<font color="black">&#62;</font> Application<font color="black">:</font><font color="black">:</font>searchPaths;
Application<font color="black">:</font><font color="black">:</font>Application<font color="black">(</font><font color="black">)</font> <font color="black">:</font> running<font color="black">(</font><font color="blue">false</font><font color="black">)</font>, frameCount<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>, fpsTime<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>, fps<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>
    Renderer<font color="black">:</font><font color="black">:</font>SetTextureManager<font color="black">(</font>defaultTextureManager<font color="black">)</font>;
    Renderer<font color="black">:</font><font color="black">:</font>SetShaderManager<font color="black">(</font>defaultShaderManager<font color="black">)</font>;
    Renderer<font color="black">:</font><font color="black">:</font>SetFontManager<font color="black">(</font>defaultFontManager<font color="black">)</font>;   
<font color="black">}</font>
Application<font color="black">:</font><font color="black">:</font>~Application<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    Close<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> Application<font color="black">:</font><font color="black">:</font>Initialize<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">return</font> Initialize<font color="black">(</font><font color="maroon">800</font>,<font color="maroon">600</font>,<font color="maroon">32</font>,<font color="maroon">0</font>,<font color="blue">false</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> Application<font color="black">:</font><font color="black">:</font>Initialize<font color="black">(</font><font color="blue">int</font> width,<font color="blue">int</font> height,<font color="blue">int</font> bpp,<font color="blue">int</font> multisample,<font color="blue">bool</font> fullscreen<font color="black">)</font>
<font color="black">{</font>
    SDL_Surface <font color="black">*</font>screen;
    <font color="blue">if</font> <font color="black">(</font>SDL_Init<font color="black">(</font>SDL_INIT_VIDEO<font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_RED_SIZE, <font color="maroon">8</font><font color="black">)</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_GREEN_SIZE, <font color="maroon">8</font><font color="black">)</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_BLUE_SIZE, <font color="maroon">8</font><font color="black">)</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_ALPHA_SIZE, <font color="maroon">8</font><font color="black">)</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_DEPTH_SIZE, <font color="maroon">24</font><font color="black">)</font>;
    SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_DOUBLEBUFFER, <font color="maroon">1</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>multisample<font color="black">)</font>
    <font color="black">{</font>
        SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_MULTISAMPLEBUFFERS,<font color="maroon">1</font><font color="black">)</font>;
        SDL_GL_SetAttribute<font color="black">(</font>SDL_GL_MULTISAMPLESAMPLES,multisample<font color="black">)</font>;
    <font color="black">}</font>

    screen<font color="black">=</font>SDL_SetVideoMode<font color="black">(</font>width,height,bpp,SDL_OPENGL <font color="black">|</font> <font color="black">(</font>fullscreen ? SDL_FULLSCREEN <font color="black">:</font> SDL_RESIZABLE<font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>screen<font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;

    Renderer<font color="black">:</font><font color="black">:</font>SetViewport<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font>,width,height<font color="black">)</font>;    
    Renderer<font color="black">:</font><font color="black">:</font>SetPerspectiveProjection<font color="black">(</font><font color="maroon">90</font>.0f,<font color="maroon">0</font>.1f,<font color="maroon">100</font><font color="black">)</font>; 
    Renderer<font color="black">:</font><font color="black">:</font>SetModelViewMatrix<font color="black">(</font>mat4<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>width<font color="black">=</font>width;
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>height<font color="black">=</font>height;    
    <font color="blue">return</font> InitializeNoWindow<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> Application<font color="black">:</font><font color="black">:</font>InitializeNoWindow<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>       
    Logger<font color="black">:</font><font color="black">:</font>Init<font color="black">(</font><font color="maroon">"log.txt"</font><font color="black">)</font>;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, string<font color="black">(</font><font color="maroon">"Initializing application"</font><font color="black">)</font><font color="black">)</font>;    
    timer.Init<font color="black">(</font><font color="black">)</font>;
    glEnable<font color="black">(</font>GL_DEPTH_TEST<font color="black">)</font>;    
    glEnable<font color="black">(</font>GL_CULL_FACE<font color="black">)</font>;
    srand<font color="black">(</font>GetTickCount<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    FT_Init_FreeType<font color="black">(</font><font color="black">&</font>freeTypeLibrary<font color="black">)</font>; 
    InitializeRenderer<font color="black">(</font><font color="black">)</font>;   
    <font color="blue">return</font> Init<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">bool</font> Application<font color="black">:</font><font color="black">:</font>Close<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    DestroyRenderer<font color="black">(</font><font color="black">)</font>;      
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, string<font color="black">(</font><font color="maroon">"Destroying application"</font><font color="black">)</font><font color="black">)</font>;     
    SDL_Quit<font color="black">(</font><font color="black">)</font>;     
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">void</font> Application<font color="black">:</font><font color="black">:</font>Run<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    running<font color="black">=</font><font color="blue">true</font>;
    SDL_Event event;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, string<font color="black">(</font><font color="maroon">"Entering main loop..."</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">while</font> <font color="black">(</font>running<font color="black">)</font>
    <font color="black">{</font>       
        deltaTime<font color="black">=</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font>timer.Passed<font color="black">(</font><font color="black">)</font>;        
        timer.Update<font color="black">(</font><font color="black">)</font>;
        <font color="blue">while</font><font color="black">(</font>SDL_PollEvent<font color="black">(</font><font color="black">&</font>event<font color="black">)</font><font color="black">)</font> 
        <font color="black">{</font>                                               
            <font color="blue">if</font> <font color="black">(</font>event.type<font color="black">=</font><font color="black">=</font>SDL_KEYDOWN<font color="black">)</font>
            <font color="black">{</font>                               
                <font color="blue">if</font> <font color="black">(</font>event.key.keysym.sym<font color="black">=</font><font color="black">=</font>SDLK_ESCAPE<font color="black">)</font>
                <font color="black">{</font>
                    running<font color="black">=</font><font color="blue">false</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font>event.type<font color="black">=</font><font color="black">=</font>SDL_VIDEORESIZE<font color="black">)</font>
            <font color="black">{</font>
                width<font color="black">=</font>event.resize.w;
                height<font color="black">=</font>event.resize.h;
                Renderer<font color="black">:</font><font color="black">:</font>SetViewport<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font>,event.resize.w,event.resize.h<font color="black">)</font>;                               
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font>event.type<font color="black">=</font><font color="black">=</font>SDL_QUIT<font color="black">)</font> 
                running<font color="black">=</font><font color="blue">false</font>;                                  
        <font color="black">}</font>
        HandleInput<font color="black">(</font>deltaTime<font color="black">)</font>;     
        Update<font color="black">(</font>deltaTime<font color="black">)</font>;
        Render<font color="black">(</font>deltaTime<font color="black">)</font>;      
        SDL_GL_SwapBuffers<font color="black">(</font><font color="black">)</font>;
        frameCount<font color="black">+</font><font color="black">=</font><font color="maroon">1</font>.0f;
        fpsTime<font color="black">+</font><font color="black">=</font>deltaTime;
        <font color="blue">if</font> <font color="black">(</font>fpsTime<font color="black">&#62;</font><font color="black">=</font><font color="maroon">1</font>.0f<font color="black">)</font>
        <font color="black">{</font>
            fps<font color="black">=</font>frameCount<font color="black">/</font>fpsTime;
            fpsTime<font color="black">-</font><font color="black">=</font><font color="maroon">1</font>.0f;
            frameCount<font color="black">=</font><font color="maroon">0</font>;
        <font color="black">}</font>       
    <font color="black">}</font>   
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, string<font color="black">(</font><font color="maroon">"Exiting main loop..."</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Application<font color="black">:</font><font color="black">:</font>SetTitle<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>title<font color="black">)</font>
<font color="black">{</font>
    SDL_WM_SetCaption<font color="black">(</font>title.c_str<font color="black">(</font><font color="black">)</font>,NULL<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">float</font> Application<font color="black">:</font><font color="black">:</font>GetFps<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> fps;
<font color="black">}</font>
<font color="blue">bool</font> Application<font color="black">:</font><font color="black">:</font>Init<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">int</font> Application<font color="black">:</font><font color="black">:</font>GetWidth<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> width;
<font color="black">}</font>
<font color="blue">int</font> Application<font color="black">:</font><font color="black">:</font>GetHeight<font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> height;
<font color="black">}</font>
<font color="blue">void</font> Application<font color="black">:</font><font color="black">:</font>AddSearchPath<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>path<font color="black">)</font>
<font color="black">{</font>
    string npath<font color="black">=</font>path;
    <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>npath<font color="black">[</font>npath.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font><font color="black">=</font><font color="black">=</font><font color="maroon">'\\'</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font>npath<font color="black">[</font>npath.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font><font color="black">=</font><font color="black">=</font><font color="maroon">'/'</font><font color="black">)</font><font color="black">)</font>
        npath<font color="black">=</font>npath.substr<font color="black">(</font><font color="maroon">0</font>,npath.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">)</font>;
    Application<font color="black">:</font><font color="black">:</font>searchPaths.push_back<font color="black">(</font>npath<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">const</font> vector<font color="black">&#60;</font>string<font color="black">&#62;</font> <font color="black">&</font>Application<font color="black">:</font><font color="black">:</font>GetSearchPaths<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> Application<font color="black">:</font><font color="black">:</font>searchPaths;
<font color="black">}</font>
std<font color="black">:</font><font color="black">:</font>string Application<font color="black">:</font><font color="black">:</font>SearchForFileName<font color="black">(</font><font color="blue">const</font> std<font color="black">:</font><font color="black">:</font>string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">bool</font> found<font color="black">=</font><font color="blue">false</font>;
    string ret;     
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>FileExists<font color="black">(</font>filename<font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">const</font> vector<font color="black">&#60;</font>string<font color="black">&#62;</font> <font color="black">&</font>searchPaths<font color="black">=</font>Application<font color="black">:</font><font color="black">:</font>GetSearchPaths<font color="black">(</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>searchPaths.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            ret<font color="black">=</font>searchPaths<font color="black">[</font>i<font color="black">]</font> <font color="black">+</font> <font color="maroon">"\\"</font> <font color="black">+</font> filename;
            <font color="blue">if</font> <font color="black">(</font>FileExists<font color="black">(</font>ret<font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>
                found<font color="black">=</font><font color="blue">true</font>;
                <font color="blue">break</font>;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
        <font color="blue">return</font> filename;

    <font color="blue">if</font> <font color="black">(</font>found<font color="black">)</font>
        <font color="blue">return</font> ret;
    <font color="blue">else</font>
        <font color="blue">return</font> <font color="maroon">""</font>;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
