<HTML>
<HEAD>
<TITLE>
FrameBuffer.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;Windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;gl/GL.h&#62;</font>

<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Geometry.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"ShaderGenerator.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>               
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;

FrameBufferResource<font color="black">:</font><font color="black">:</font>FrameBufferResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> id<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>,depthBuffer<font color="black">(</font><font color="maroon">0</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
FrameBufferResource<font color="black">:</font><font color="black">:</font>~FrameBufferResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>id<font color="black">)</font>
    <font color="black">{</font>
        glDeleteFramebuffersEXT<font color="black">(</font><font color="maroon">1</font>, <font color="black">&</font>id<font color="black">)</font>;
        id<font color="black">=</font><font color="maroon">0</font>;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>depthBuffer<font color="black">)</font>
    <font color="black">{</font>
        glDeleteRenderbuffersEXT<font color="black">(</font><font color="maroon">1</font>, <font color="black">&</font>depthBuffer<font color="black">)</font>;
        depthBuffer<font color="black">=</font><font color="maroon">0</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">void</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="blue">int</font> width,<font color="blue">int</font> height<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>width<font color="black">=</font>width;
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>height<font color="black">=</font>height;
    glGenFramebuffersEXT<font color="black">(</font><font color="maroon">1</font>,<font color="black">&</font>id<font color="black">)</font>;    
<font color="black">}</font>
<font color="blue">void</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>SetRenderTarget<font color="black">(</font>Texture texture,<font color="blue">int</font> attachmnetPoint<font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>texture<font color="black">[</font>attachmnetPoint<font color="black">]</font><font color="black">=</font>texture;
    Renderer<font color="black">:</font><font color="black">:</font>UseTexture<font color="black">(</font>texture,<font color="maroon">0</font><font color="black">)</font>;    
    glTexImage2D<font color="black">(</font>GL_TEXTURE_2D,<font color="maroon">0</font>,GL_RGBA8,width,height,<font color="maroon">0</font>,GL_RGBA,GL_UNSIGNED_BYTE,NULL<font color="black">)</font>;
    glTexParameterf<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameterf<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR<font color="black">)</font>;   
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR<font color="black">)</font>;     

    glFramebufferTexture2DEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,GL_COLOR_ATTACHMENT0<font color="black">+</font>attachmnetPoint,GL_TEXTURE_2D,texture<font color="black">-</font><font color="black">&#62;</font>id,<font color="maroon">0</font><font color="black">)</font>; 
    glBindFramebufferEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,id<font color="black">)</font>;    
<font color="black">}</font>
<font color="blue">void</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>AddDepthBuffer<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glBindFramebufferEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,id<font color="black">)</font>;
    glGenRenderbuffersEXT<font color="black">(</font><font color="maroon">1</font>,<font color="black">&</font>depthBuffer<font color="black">)</font>;
    glBindRenderbufferEXT<font color="black">(</font>GL_RENDERBUFFER_EXT,depthBuffer<font color="black">)</font>;
    glRenderbufferStorageEXT<font color="black">(</font>GL_RENDERBUFFER_EXT,GL_DEPTH_COMPONENT,width,height<font color="black">)</font>;
    glFramebufferRenderbufferEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,GL_DEPTH_ATTACHMENT_EXT,GL_RENDERBUFFER_EXT,depthBuffer<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>AddDepthBufferTexture<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    glBindFramebufferEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,id<font color="black">)</font>;
    depthTexture<font color="black">=</font>Texture<font color="black">(</font><font color="blue">new</font> TextureResource<font color="black">)</font>;
    depthTexture<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
    Renderer<font color="black">:</font><font color="black">:</font>UseTexture<font color="black">(</font>depthTexture,<font color="maroon">0</font><font color="black">)</font>;   
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameteri<font color="black">(</font> GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR <font color="black">)</font>;
    glTexParameteri<font color="black">(</font> GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR <font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_COMPARE_MODE_ARB, GL_COMPARE_R_TO_TEXTURE_ARB<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_COMPARE_FUNC_ARB, GL_LEQUAL<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_DEPTH_TEXTURE_MODE_ARB, GL_INTENSITY<font color="black">)</font>;
    glTexImage2D <font color="black">(</font>GL_TEXTURE_2D, <font color="maroon">0</font>, GL_DEPTH_COMPONENT24, width, height, <font color="maroon">0</font>, GL_DEPTH_COMPONENT, GL_UNSIGNED_BYTE, NULL<font color="black">)</font>;
    
    glFramebufferTexture2DEXT <font color="black">(</font>GL_FRAMEBUFFER_EXT, GL_DEPTH_ATTACHMENT_EXT, GL_TEXTURE_2D, depthTexture<font color="black">-</font><font color="black">&#62;</font>id, <font color="maroon">0</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>AddRenderTarget<font color="black">(</font><font color="blue">int</font> attachmnetPoint<font color="black">)</font>
<font color="black">{</font>
    glBindFramebuffer<font color="black">(</font>GL_FRAMEBUFFER_EXT,id<font color="black">)</font>;           
    glDrawBuffer<font color="black">(</font>GL_FRONT_AND_BACK<font color="black">)</font>;
    texture<font color="black">[</font>attachmnetPoint<font color="black">]</font><font color="black">=</font>Texture<font color="black">(</font><font color="blue">new</font> TextureResource<font color="black">)</font>;
    texture<font color="black">[</font>attachmnetPoint<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
    Renderer<font color="black">:</font><font color="black">:</font>UseTexture<font color="black">(</font>texture<font color="black">[</font>attachmnetPoint<font color="black">]</font>,<font color="maroon">0</font><font color="black">)</font>;   
    glTexImage2D<font color="black">(</font>GL_TEXTURE_2D,<font color="maroon">0</font>,GL_RGBA8,width,height,<font color="maroon">0</font>,GL_RGBA,GL_UNSIGNED_BYTE,NULL<font color="black">)</font>;
    glTexParameterf<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameterf<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE<font color="black">)</font>;
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR_MIPMAP_LINEAR<font color="black">)</font>; 
    glTexParameteri<font color="black">(</font>GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR_MIPMAP_LINEAR<font color="black">)</font>;     
    glFramebufferTexture2DEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT,GL_COLOR_ATTACHMENT0_EXT<font color="black">+</font>attachmnetPoint,GL_TEXTURE_2D,texture<font color="black">[</font>attachmnetPoint<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>id,<font color="maroon">0</font><font color="black">)</font>;    
<font color="black">}</font>
Texture FrameBufferResource<font color="black">:</font><font color="black">:</font>GetRenderTarget<font color="black">(</font><font color="blue">int</font> attachmnetPoint<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> texture<font color="black">[</font>attachmnetPoint<font color="black">]</font>;
<font color="black">}</font>
Texture FrameBufferResource<font color="black">:</font><font color="black">:</font>GetDepthBuffer<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> depthTexture;
<font color="black">}</font>

<font color="blue">bool</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>IsValid<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>id<font color="black">=</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
        
    glBindFramebuffer<font color="black">(</font>GL_FRAMEBUFFER_EXT,id<font color="black">)</font>;
    <font color="blue">bool</font> found<font color="black">=</font><font color="blue">false</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;<font color="black">(</font>i<font color="black">&#60;</font>MAX_TEXTURES<font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font><font color="black">!</font>found<font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>texture<font color="black">[</font>i<font color="black">]</font><font color="black">)</font> <font color="black">&</font><font color="black">&</font> <font color="black">(</font>texture<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font>IsValid<font color="black">(</font><font color="black">)</font><font color="black">)</font><font color="black">)</font>
            found<font color="black">=</font><font color="blue">true</font>;
    <font color="blue">if</font> <font color="black">(</font>found<font color="black">)</font>
        glDrawBuffer<font color="black">(</font>GL_BACK<font color="black">)</font>;
    <font color="blue">else</font>
        glDrawBuffer<font color="black">(</font>GL_NONE<font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>glCheckFramebufferStatusEXT<font color="black">(</font>GL_FRAMEBUFFER_EXT<font color="black">)</font><font color="black">!</font><font color="black">=</font>GL_FRAMEBUFFER_COMPLETE_EXT<font color="black">)</font>
        <font color="blue">return</font> <font color="blue">false</font>;
    <font color="blue">return</font> <font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">int</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>GetWidth<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> width;
<font color="black">}</font>
<font color="blue">int</font> FrameBufferResource<font color="black">:</font><font color="black">:</font>GetHeight<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> height;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
