<HTML>
<HEAD>
<TITLE>
Geometry.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL_image.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;GL/GLU.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Geometry.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Image.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"RenderQueue.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>
<font color="blue">#include</font> <font color="maroon">"tinyxml.h"</font>
<font color="blue">#include</font> <font color="maroon">"Light.h"</font>
<font color="blue">#include</font> <font color="maroon">"Node.h"</font>
<font color="blue">#include</font> <font color="maroon">"ModelLoaders.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;
MaterialResource<font color="black">:</font><font color="black">:</font>MaterialResource<font color="black">(</font><font color="black">)</font> <font color="black">:</font> shininess<font color="black">(</font><font color="maroon">128</font>.0f<font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
MaterialResource<font color="black">:</font><font color="black">:</font>~MaterialResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>MaterialResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> MaterialResource<font color="black">)</font>;
<font color="black">}</font>
string Material<font color="black">:</font><font color="black">:</font>GetName<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font>;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetName<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font><font color="blue">name</font>;
<font color="black">}</font>
vec4 Material<font color="black">:</font><font color="black">:</font>GetAmbientColor<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>ambient;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetAmbientColor<font color="black">(</font>vec4 color<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>ambient<font color="black">=</font>color;
<font color="black">}</font>
vec4 Material<font color="black">:</font><font color="black">:</font>GetDiffuseColor<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>diffuse;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetDiffuseColor<font color="black">(</font>vec4 color<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>diffuse<font color="black">=</font>color;
<font color="black">}</font>
vec4 Material<font color="black">:</font><font color="black">:</font>GetSpecularColor<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>specular;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetSpecularColor<font color="black">(</font>vec4 color<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>specular<font color="black">=</font>color;
<font color="black">}</font>
<font color="blue">float</font> Material<font color="black">:</font><font color="black">:</font>GetShininess<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>shininess;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetShininess<font color="black">(</font><font color="blue">float</font> value<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>shininess<font color="black">=</font>value;
<font color="black">}</font>
Texture Material<font color="black">:</font><font color="black">:</font>GetDiffuseTexture<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>diffuseTexture;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetDiffuseTexture<font color="black">(</font>Texture texture<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>diffuseTexture<font color="black">=</font>texture;
<font color="black">}</font>
Texture Material<font color="black">:</font><font color="black">:</font>GetNormalTexture<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>normalTexture;
<font color="black">}</font>
<font color="blue">void</font> Material<font color="black">:</font><font color="black">:</font>SetNormalTexture<font color="black">(</font>Texture texture<font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">-</font><font color="black">&#62;</font>normalTexture<font color="black">=</font>texture;
<font color="black">}</font>
Material<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Material<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Material <font color="black">&</font>material<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">=</font><font color="black">=</font>material.resource;
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>Face<font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> v0,<font color="blue">unsigned</font> <font color="blue">int</font> v1,<font color="blue">unsigned</font> <font color="blue">int</font> v2<font color="black">)</font>
<font color="black">{</font>
    v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>v0;
    v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>v1;
    v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>v2;
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>~Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
GeometryResource<font color="black">:</font><font color="black">:</font>~GeometryResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_INFO, string<font color="black">(</font><font color="maroon">"Destroyed geometry"</font><font color="black">)</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>Create<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    resource<font color="black">=</font>boost<font color="black">:</font><font color="black">:</font>shared_ptr<font color="black">&#60;</font>GeometryResource<font color="black">&#62;</font><font color="black">(</font><font color="blue">new</font> GeometryResource<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>CalculateNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    resource<font color="black">-</font><font color="black">&#62;</font>normal.resize<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;       
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>           
        resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>n<font color="black">]</font><font color="black">=</font>vec3<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;        
    <font color="black">}</font>
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        vec3 v1<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
        vec3 v2<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
        vec3 n<font color="black">=</font>Cross<font color="black">(</font>v1,v2<font color="black">)</font>;            
        resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.normal<font color="black">=</font>n;
        resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.normal.Normalize<font color="black">(</font><font color="black">)</font>;
        <font color="green">/*for (unsigned int i=0;i&#60;vertex.size();i++)                    // Fix texture coordinate problem having certain vertices duplicated. SLOW.
        {
        if (vertex[i]==vertex[face[f].v[0]])
        {               
        normal[i]+=n;
        count[i]++;             
        }
        if (vertex[i]==vertex[face[f].v[1]])
        {               
        normal[i]+=n;
        count[i]++;
        }
        if (vertex[i]==vertex[face[f].v[2]])
        {               
        normal[i]+=n;
        count[i]++;
        }
        }*/</font>
        resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
        resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
        resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
    <font color="black">}</font>       
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>           
        resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>n<font color="black">]</font>.Normalize<font color="black">(</font><font color="black">)</font>;        
    <font color="black">}</font>       
    resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.Create<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>CalculateTangents<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font><font color="black">)</font> <font color="black">|</font><font color="black">|</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.size<font color="black">(</font><font color="black">)</font> <font color="black">=</font><font color="black">=</font> <font color="maroon">0</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">return</font>;
    vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> tan<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">2</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>tan.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        tan<font color="black">[</font>i<font color="black">]</font>.Set<font color="black">(</font><font color="maroon">0</font>.0f,<font color="maroon">0</font>.0f,<font color="maroon">0</font>.0f<font color="black">)</font>;

    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        Face <font color="black">&</font>face<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>;
        
        vec3 v0<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
        vec3 v1<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
        vec3 v2<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;

        vec2 uv0<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
        vec2 uv1<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
        vec2 uv2<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;

        <font color="blue">float</font> x1 <font color="black">=</font> v1.x <font color="black">-</font>v0.x;
        <font color="blue">float</font> x2 <font color="black">=</font> v2.x <font color="black">-</font>v0.x;
        <font color="blue">float</font> y1 <font color="black">=</font> v1.y <font color="black">-</font>v0.y;
        <font color="blue">float</font> y2 <font color="black">=</font> v2.y <font color="black">-</font>v0.y;
        <font color="blue">float</font> z1 <font color="black">=</font> v1.z <font color="black">-</font>v0.z;
        <font color="blue">float</font> z2 <font color="black">=</font> v2.z <font color="black">-</font>v0.z;

        <font color="blue">float</font> s1 <font color="black">=</font> uv1.x <font color="black">-</font>uv0.x;
        <font color="blue">float</font> s2 <font color="black">=</font> uv2.x <font color="black">-</font>uv0.x;
        <font color="blue">float</font> t1 <font color="black">=</font> uv1.y <font color="black">-</font>uv0.y;
        <font color="blue">float</font> t2 <font color="black">=</font> uv2.y <font color="black">-</font>uv0.y;

        <font color="blue">float</font> r <font color="black">=</font> <font color="maroon">1</font>.0f <font color="black">/</font> <font color="black">(</font>s1 <font color="black">*</font> t2 <font color="black">-</font>s2 <font color="black">*</font> t1<font color="black">)</font>;
        vec3 sdir<font color="black">(</font><font color="black">(</font>t2 <font color="black">*</font> x1 <font color="black">-</font>t1 <font color="black">*</font> x2<font color="black">)</font> <font color="black">*</font> r, <font color="black">(</font>t2 <font color="black">*</font> y1 <font color="black">-</font>t1 <font color="black">*</font> y2<font color="black">)</font> <font color="black">*</font> r,
            <font color="black">(</font>t2 <font color="black">*</font> z1 <font color="black">-</font>t1 <font color="black">*</font> z2<font color="black">)</font> <font color="black">*</font> r<font color="black">)</font>;
        vec3 tdir<font color="black">(</font><font color="black">(</font>s1 <font color="black">*</font> x2 <font color="black">-</font>s2 <font color="black">*</font> x1<font color="black">)</font> <font color="black">*</font> r, <font color="black">(</font>s1 <font color="black">*</font> y2 <font color="black">-</font>s2 <font color="black">*</font> y1<font color="black">)</font> <font color="black">*</font> r,
            <font color="black">(</font>s1 <font color="black">*</font> z2 <font color="black">-</font>s2 <font color="black">*</font> z1<font color="black">)</font> <font color="black">*</font> r<font color="black">)</font>;

        tan<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> sdir;
        tan<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> sdir;
        tan<font color="black">[</font>face.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> sdir;

        tan<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">+</font>face.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> tdir;
        tan<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">+</font>face.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> tdir;
        tan<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">+</font>face.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font> <font color="black">+</font><font color="black">=</font> tdir;
    <font color="black">}</font>
    resource<font color="black">-</font><font color="black">&#62;</font>tangent.resize<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>bitangent.resize<font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        vec3 n<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font>i<font color="black">]</font>;
        vec3 t1<font color="black">=</font>tan<font color="black">[</font>i<font color="black">]</font>;
        vec3 t2<font color="black">=</font>tan<font color="black">[</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="black">+</font>i<font color="black">]</font>;

        resource<font color="black">-</font><font color="black">&#62;</font>tangent<font color="black">[</font>i<font color="black">]</font><font color="black">=</font><font color="black">(</font>t1 <font color="black">-</font>n <font color="black">*</font> Dot<font color="black">(</font>n, t1<font color="black">)</font><font color="black">)</font>.Normalize<font color="black">(</font><font color="black">)</font>;
        <font color="blue">float</font> w<font color="black">=</font><font color="black">(</font>Dot<font color="black">(</font>Cross<font color="black">(</font>n, t1<font color="black">)</font>, t2<font color="black">)</font> <font color="black">&#60;</font> <font color="maroon">0</font>.0f<font color="black">)</font> ? <font color="maroon">-1</font>.0f <font color="black">:</font> <font color="maroon">1</font>.0f;
        resource<font color="black">-</font><font color="black">&#62;</font>bitangent<font color="black">[</font>i<font color="black">]</font><font color="black">=</font><font color="black">(</font>Cross<font color="black">(</font>n,resource<font color="black">-</font><font color="black">&#62;</font>tangent<font color="black">[</font>i<font color="black">]</font><font color="black">)</font><font color="black">*</font>w<font color="black">)</font>.Normalize<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.Create<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>tangent<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>tangent.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.Create<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangent<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangent.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>CreateHardNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> originalVertices;
    vector<font color="black">&#60;</font>vec2<font color="black">&#62;</font> originalDiffuseUV;
    <font color="blue">unsigned</font> <font color="blue">int</font> currentIndex<font color="black">=</font><font color="maroon">0</font>;
    originalVertices<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex;
    originalDiffuseUV<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV;
    resource<font color="black">-</font><font color="black">&#62;</font>face.clear<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>vertex.clear<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>normal.clear<font color="black">(</font><font color="black">)</font>;
    resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.clear<font color="black">(</font><font color="black">)</font>;

    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>surface.size<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        Surface <font color="black">&</font>surface<font color="black">=</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>resource<font color="black">-</font><font color="black">&#62;</font>surface<font color="black">[</font>j<font color="black">]</font>;
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>surface.face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>               
            vec3 v0<font color="black">=</font>originalVertices<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
            vec3 v1<font color="black">=</font>originalVertices<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
            vec3 v2<font color="black">=</font>originalVertices<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;
            vec3 n<font color="black">=</font>Cross<font color="black">(</font>v1<font color="black">-</font>v0,v2<font color="black">-</font>v0<font color="black">)</font>.Normalize<font color="black">(</font><font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v0<font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v1<font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v2<font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>normal.push_back<font color="black">(</font>n<font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>normal.push_back<font color="black">(</font>n<font color="black">)</font>;
            resource<font color="black">-</font><font color="black">&#62;</font>normal.push_back<font color="black">(</font>n<font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font>originalDiffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">&#62;</font><font color="maroon">0</font><font color="black">)</font>
            <font color="black">{</font>
                vec2 uv0<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>,uv1<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>,uv2<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;
                uv0<font color="black">=</font>originalDiffuseUV<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
                uv1<font color="black">=</font>originalDiffuseUV<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
                uv2<font color="black">=</font>originalDiffuseUV<font color="black">[</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;

                resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.push_back<font color="black">(</font>uv0<font color="black">)</font>;
                resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.push_back<font color="black">(</font>uv1<font color="black">)</font>;
                resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.push_back<font color="black">(</font>uv2<font color="black">)</font>;
            <font color="black">}</font>                                   
            surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;
            surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;
            surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;                
            resource<font color="black">-</font><font color="black">&#62;</font>face.push_back<font color="black">(</font>surface.face<font color="black">[</font>i<font color="black">]</font><font color="black">)</font>;
        <font color="black">}</font>
        vector<font color="black">&#60;</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">&#62;</font> tmp;
        tmp.resize<font color="black">(</font>surface.face.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">3</font><font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>surface.face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>surface.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
            tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>surface.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>;
            tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>surface.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
        <font color="black">}</font>           
    <font color="black">}</font>       
    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>           
        resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.Create<font color="black">(</font><font color="black">)</font>;
        resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec2<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    <font color="black">}</font>       

    UpdateBuffers<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>UpdateBuffers<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>vertexBuffer<font color="black">)</font>
    <font color="black">{</font>       
        resource<font color="black">-</font><font color="black">&#62;</font>vertexBuffer.Create<font color="black">(</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>vertexBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
    <font color="black">{</font>
        ostringstream oss;
        oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>vertexBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
        Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer<font color="black">)</font>
        <font color="black">{</font>           
            resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>normal<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>normal.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
        resource<font color="black">-</font><font color="black">&#62;</font>normalBuffer.Destroy<font color="black">(</font><font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>tangent.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer<font color="black">)</font>
        <font color="black">{</font>           
            resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>tangent<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>tangent.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
        resource<font color="black">-</font><font color="black">&#62;</font>tangentBuffer.Destroy<font color="black">(</font><font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangent.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer<font color="black">)</font>
        <font color="black">{</font>           
            resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangent<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangent.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
        resource<font color="black">-</font><font color="black">&#62;</font>bitangentBuffer.Destroy<font color="black">(</font><font color="black">)</font>;

    <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer<font color="black">)</font>
        <font color="black">{</font>           
            resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec2<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">else</font>
        resource<font color="black">-</font><font color="black">&#62;</font>diffuseUVBuffer.Destroy<font color="black">(</font><font color="black">)</font>;



    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> m<font color="black">=</font><font color="maroon">0</font>;m<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>surface.size<font color="black">(</font><font color="black">)</font>;m<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        Surface <font color="black">&</font>surface<font color="black">=</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>resource<font color="black">-</font><font color="black">&#62;</font>surface<font color="black">[</font>m<font color="black">]</font>;
        vector<font color="black">&#60;</font><font color="blue">unsigned</font> <font color="blue">int</font><font color="black">&#62;</font> indices;
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>surface.face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            indices.push_back<font color="black">(</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">)</font>;
            indices.push_back<font color="black">(</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">)</font>;
            indices.push_back<font color="black">(</font>surface.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>surface.indexBuffer<font color="black">)</font>
        <font color="black">{</font>           
            surface.indexBuffer.Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>surface.indexBuffer.LoadIndexData<font color="black">(</font><font color="black">&</font>indices<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,indices.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>surface.indexBuffer.GetId<font color="black">(</font><font color="black">)</font> <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font>;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>Logger<font color="black">:</font><font color="black">:</font>LOG_ERROR, oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
<font color="black">}</font>
Geometry Geometry<font color="black">:</font><font color="black">:</font>Reduce<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    Geometry geometry;
    geometry.Create<font color="black">(</font><font color="black">)</font>;
    geometry.resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>face; 

    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>geometry.resource<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font><font color="maroon">3</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            vec3 v<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>geometry.resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">]</font>;
            <font color="blue">bool</font> found<font color="black">=</font><font color="blue">false</font>;
            <font color="blue">unsigned</font> <font color="blue">int</font> k;
            <font color="blue">for</font> <font color="black">(</font>k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>geometry.resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>k<font color="black">]</font><font color="black">-</font>v<font color="black">)</font>.Length2<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font>.0f<font color="black">)</font>
                <font color="black">{</font>
                    found<font color="black">=</font><font color="blue">true</font>;
                    <font color="blue">break</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font>found<font color="black">=</font><font color="black">=</font><font color="blue">false</font><font color="black">)</font>
            <font color="black">{</font>
                geometry.resource<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v<font color="black">)</font>;
                geometry.resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>geometry.resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
            <font color="black">{</font>
                geometry.resource<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>k;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> geometry;
<font color="black">}</font>
Material Geometry<font color="black">:</font><font color="black">:</font>GetMaterialByName<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>material.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font>resource<font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font>i<font color="black">]</font>.GetName<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="blue">name</font><font color="black">)</font>
            <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font>i<font color="black">]</font>;
    <font color="black">}</font>
    <font color="blue">return</font> Material<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>ApplyTransformation<font color="black">(</font>mat4 <font color="black">&</font>transform<font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>i<font color="black">]</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>i<font color="black">]</font><font color="black">*</font>transform;
    <font color="black">}</font>
    resource<font color="black">-</font><font color="black">&#62;</font>vertexBuffer.LoadData<font color="black">(</font><font color="black">&</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;

    CalculateNormals<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
BoundingBox Geometry<font color="black">:</font><font color="black">:</font>GetBoundingBox<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>bbox;
<font color="black">}</font>
<font color="blue">void</font> Geometry<font color="black">:</font><font color="black">:</font>CalculateBoundingBox<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator j<font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.begin<font color="black">(</font><font color="black">)</font>;j<font color="black">!</font><font color="black">=</font>resource<font color="black">-</font><font color="black">&#62;</font>vertex.end<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        resource<font color="black">-</font><font color="black">&#62;</font>bbox.Expand<font color="black">(</font><font color="black">*</font>j<font color="black">)</font>;
    <font color="black">}</font>       
<font color="black">}</font>
vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetVertices<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>vertex;
<font color="black">}</font>
vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>normal;
<font color="black">}</font>
vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetTangents<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>tangent;
<font color="black">}</font>
vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetBitangents<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>bitangent;
<font color="black">}</font>
vector<font color="black">&#60;</font>Face<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetFaces<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>face;
<font color="black">}</font>
vector<font color="black">&#60;</font>vec2<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetDiffuseUV<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>diffuseUV;
<font color="black">}</font>
vector<font color="black">&#60;</font>Surface<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetSurfaces<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>surface;
<font color="black">}</font>
vector<font color="black">&#60;</font>Material<font color="black">&#62;</font> <font color="black">&</font>Geometry<font color="black">:</font><font color="black">:</font>GetMaterials<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">-</font><font color="black">&#62;</font>material;
<font color="black">}</font>
Geometry<font color="black">:</font><font color="black">:</font><font color="blue">operator</font> <font color="blue">bool</font> <font color="black">(</font><font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource;
<font color="black">}</font>
<font color="blue">bool</font> Geometry<font color="black">:</font><font color="black">:</font><font color="blue">operator</font><font color="black">=</font><font color="black">=</font> <font color="black">(</font><font color="blue">const</font> Geometry <font color="black">&</font>geometry<font color="black">)</font> <font color="blue">const</font>
<font color="black">{</font>
    <font color="blue">return</font> resource<font color="black">=</font><font color="black">=</font>geometry.resource;
<font color="black">}</font>

</PRE>
</BODY>
</HTML>
