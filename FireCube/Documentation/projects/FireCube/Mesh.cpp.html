<HTML>
<HEAD>
<TITLE>
Mesh.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL_image.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;GL/GLU.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Mesh.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Image.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>               
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>
<font color="blue">#include</font> <font color="maroon">"tinyxml.h"</font>
<font color="blue">#include</font> <font color="maroon">"ModelLoaders.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;
MaterialResource<font color="black">:</font><font color="black">:</font>MaterialResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
MaterialResource<font color="black">:</font><font color="black">:</font>~MaterialResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>Face<font color="black">(</font>DWORD v0,DWORD v1,DWORD v2<font color="black">)</font>
<font color="black">{</font>
    v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>v0;
    v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>v1;
    v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>v2;
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>~Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Mesh<font color="black">:</font><font color="black">:</font>Mesh<font color="black">(</font><font color="black">)</font> <font color="black">:</font> material<font color="black">(</font>Material<font color="black">(</font><font color="black">)</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Mesh<font color="black">:</font><font color="black">:</font>~Mesh<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Object<font color="black">:</font><font color="black">:</font>Object<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
ModelResource<font color="black">:</font><font color="black">:</font>ModelResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
ModelResource<font color="black">:</font><font color="black">:</font>~ModelResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>string<font color="black">(</font><font color="maroon">"Destroyed model with name:"</font><font color="black">)</font><font color="black">)</font>;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font><font color="maroon">".\n"</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> ModelResource<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    string<font color="black">:</font><font color="black">:</font>size_type d;
    d<font color="black">=</font>filename.find_last_of<font color="black">(</font><font color="maroon">"."</font><font color="black">)</font>;
    <font color="blue">name</font><font color="black">=</font>filename;
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Created model with name:"</font><font color="black">&#60;</font><font color="black">&#60;</font>filename<font color="black">&#60;</font><font color="black">&#60;</font>endl;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>d<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
    <font color="black">{</font>
        string ext<font color="black">=</font>ToLower<font color="black">(</font>filename.substr<font color="black">(</font>d<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"3ds"</font><font color="black">)</font>
        <font color="black">{</font>               
            M3dsLoader m3dsLoader<font color="black">(</font><font color="blue">this</font><font color="black">)</font>;
            
            <font color="blue">if</font> <font color="black">(</font>m3dsLoader.Load<font color="black">(</font>filename<font color="black">)</font><font color="black">)</font>                          
            <font color="black">{</font>
                CalculateBoundingBox<font color="black">(</font><font color="black">)</font>;
                <font color="blue">return</font> <font color="blue">true</font>;            
            <font color="black">}</font>
            <font color="blue">else</font>
                <font color="blue">return</font> <font color="blue">false</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"dae"</font><font color="black">)</font>
        <font color="black">{</font>               
            ColladaLoader colladaLoader<font color="black">(</font>filename<font color="black">)</font>;

            <font color="blue">if</font> <font color="black">(</font>colladaLoader.Load<font color="black">(</font><font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>
                colladaLoader.GenerateModel<font color="black">(</font><font color="blue">this</font><font color="black">)</font>;
                CalculateBoundingBox<font color="black">(</font><font color="black">)</font>;
                UpdateBuffers<font color="black">(</font><font color="black">)</font>;
                <font color="blue">return</font> <font color="blue">true</font>;
            <font color="black">}</font>
            <font color="blue">else</font>
                <font color="blue">return</font> <font color="blue">false</font>;               
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>CalculateBoundingBox<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>vector<font color="black">&#60;</font>Object<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>object.begin<font color="black">(</font><font color="black">)</font>;i<font color="black">!</font><font color="black">=</font>object.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">for</font> <font color="black">(</font>vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator j<font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>vertex.begin<font color="black">(</font><font color="black">)</font>;j<font color="black">!</font><font color="black">=</font>i<font color="black">-</font><font color="black">&#62;</font>vertex.end<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            i<font color="black">-</font><font color="black">&#62;</font>bbox.Expand<font color="black">(</font><font color="black">*</font>j<font color="black">)</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">for</font> <font color="black">(</font>vector<font color="black">&#60;</font>Object<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>object.begin<font color="black">(</font><font color="black">)</font>;i<font color="black">!</font><font color="black">=</font>object.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        bbox.Expand<font color="black">(</font>i<font color="black">-</font><font color="black">&#62;</font>bbox<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
BoundingBox ModelResource<font color="black">:</font><font color="black">:</font>GetBoundingBox<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">return</font> bbox;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>CalculateNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        object<font color="black">[</font>k<font color="black">]</font>.normal.resize<font color="black">(</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;       
        <font color="blue">for</font> <font color="black">(</font>DWORD n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>           
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>n<font color="black">]</font><font color="black">=</font>vec3<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;        
        <font color="black">}</font>
        <font color="blue">for</font> <font color="black">(</font>DWORD f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            vec3 v1<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
            vec3 v2<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
            vec3 n<font color="black">=</font>Cross<font color="black">(</font>v1,v2<font color="black">)</font>;            
            object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.normal<font color="black">=</font>n;
            object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.normal.Normalize<font color="black">(</font><font color="black">)</font>;
            <font color="green">/*for (unsigned int i=0;i&#60;object[k].vertex.size();i++)                  // Fix texture coordinate problem having certain vertices duplicated. SLOW.
            {
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[0]])
            {               
            object[k].normal[i]+=n;
            count[i]++;             
            }
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[1]])
            {               
            object[k].normal[i]+=n;
            count[i]++;
            }
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[2]])
            {               
            object[k].normal[i]+=n;
            count[i]++;
            }
            }*/</font>
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
        <font color="black">}</font>       
        <font color="blue">for</font> <font color="black">(</font>DWORD n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>           
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>n<font color="black">]</font>.Normalize<font color="black">(</font><font color="black">)</font>;        
        <font color="black">}</font>   
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>ApplyTransformation<font color="black">(</font>mat4 <font color="black">&</font>transform<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>i<font color="black">]</font><font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>i<font color="black">]</font><font color="black">*</font>transform;
        <font color="black">}</font>
        object<font color="black">[</font>k<font color="black">]</font>.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    <font color="black">}</font>
    CalculateNormals<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>

Material ModelResource<font color="black">:</font><font color="black">:</font>GetMaterialByName<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>material.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font>material<font color="black">[</font>i<font color="black">]</font><font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font><font color="black">=</font><font color="blue">name</font><font color="black">)</font>
            <font color="blue">return</font> material<font color="black">[</font>i<font color="black">]</font>;
    <font color="black">}</font>
    <font color="blue">return</font> Material<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
Model ModelResource<font color="black">:</font><font color="black">:</font>Reduce<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    Model model<font color="black">(</font><font color="blue">new</font> ModelResource<font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> l<font color="black">=</font><font color="maroon">0</font>;l<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;l<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        Object <font color="black">*</font>curObject;
        model<font color="black">-</font><font color="black">&#62;</font>object.push_back<font color="black">(</font>Object<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        curObject<font color="black">=</font><font color="black">&</font><font color="black">(</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font><font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.face;
        curObject<font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.<font color="blue">name</font>;

        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>curObject<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font><font color="maroon">3</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                vec3 v<font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.vertex<font color="black">[</font>curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">]</font>;
                <font color="blue">bool</font> found<font color="black">=</font><font color="blue">false</font>;
                <font color="blue">unsigned</font> <font color="blue">int</font> k;
                <font color="blue">for</font> <font color="black">(</font>k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font><font color="black">(</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>k<font color="black">]</font><font color="black">-</font>v<font color="black">)</font>.Length2<font color="black">(</font><font color="black">)</font><font color="black">=</font><font color="black">=</font><font color="maroon">0</font>.0f<font color="black">)</font>
                    <font color="black">{</font>
                        found<font color="black">=</font><font color="blue">true</font>;
                        <font color="blue">break</font>;
                    <font color="black">}</font>
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font>found<font color="black">=</font><font color="black">=</font><font color="blue">false</font><font color="black">)</font>
                <font color="black">{</font>
                    curObject<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v<font color="black">)</font>;
                    curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                <font color="black">{</font>
                    curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>k;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> model;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>SetProgram<font color="black">(</font><font color="blue">const</font> Program <font color="black">&</font>program<font color="black">)</font>
<font color="black">{</font>   
    vector<font color="black">&#60;</font>Material<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>material.begin<font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>;i<font color="black">!</font><font color="black">=</font>material.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>               
        <font color="black">(</font><font color="black">*</font>i<font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>program<font color="black">=</font>program;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>CreateHardNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    vector<font color="black">&#60;</font>vec3<font color="black">&#62;</font> vertices;
    vector<font color="black">&#60;</font>vec2<font color="black">&#62;</font> diffuseUV;
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        DWORD currentIndex<font color="black">=</font><font color="maroon">0</font>;
        Object <font color="black">&</font>obj<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>;
        vertices.clear<font color="black">(</font><font color="black">)</font>;
        diffuseUV.clear<font color="black">(</font><font color="black">)</font>;
        vertices<font color="black">=</font>obj.vertex;
        diffuseUV<font color="black">=</font>obj.diffuseUV;
        obj.face.clear<font color="black">(</font><font color="black">)</font>;
        obj.vertex.clear<font color="black">(</font><font color="black">)</font>;
        obj.normal.clear<font color="black">(</font><font color="black">)</font>;
        obj.diffuseUV.clear<font color="black">(</font><font color="black">)</font>;

        <font color="blue">for</font> <font color="black">(</font>DWORD j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>obj.mesh.size<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            Mesh <font color="black">&</font>ms<font color="black">=</font>obj.mesh<font color="black">[</font>j<font color="black">]</font>;
            <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>ms.face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>               
                vec3 v0<font color="black">=</font>vertices<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
                vec3 v1<font color="black">=</font>vertices<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
                vec3 v2<font color="black">=</font>vertices<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;
                vec3 n<font color="black">=</font>Cross<font color="black">(</font>v1<font color="black">-</font>v0,v2<font color="black">-</font>v0<font color="black">)</font>.Normalize<font color="black">(</font><font color="black">)</font>;
                obj.vertex.push_back<font color="black">(</font>v0<font color="black">)</font>;
                obj.vertex.push_back<font color="black">(</font>v1<font color="black">)</font>;
                obj.vertex.push_back<font color="black">(</font>v2<font color="black">)</font>;
                obj.normal.push_back<font color="black">(</font>n<font color="black">)</font>;
                obj.normal.push_back<font color="black">(</font>n<font color="black">)</font>;
                obj.normal.push_back<font color="black">(</font>n<font color="black">)</font>;
                <font color="blue">if</font> <font color="black">(</font>diffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">&#62;</font><font color="maroon">0</font><font color="black">)</font>
                <font color="black">{</font>
                    vec2 uv0<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>,uv1<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>,uv2<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;
                    uv0<font color="black">=</font>diffuseUV<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
                    uv1<font color="black">=</font>diffuseUV<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font>;
                    uv2<font color="black">=</font>diffuseUV<font color="black">[</font>ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font>;

                    obj.diffuseUV.push_back<font color="black">(</font>uv0<font color="black">)</font>;
                    obj.diffuseUV.push_back<font color="black">(</font>uv1<font color="black">)</font>;
                    obj.diffuseUV.push_back<font color="black">(</font>uv2<font color="black">)</font>;
                <font color="black">}</font>                                   
                ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;
                ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;
                ms.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>currentIndex<font color="black">+</font><font color="black">+</font>;             
                obj.face.push_back<font color="black">(</font>ms.face<font color="black">[</font>i<font color="black">]</font><font color="black">)</font>;
            <font color="black">}</font>
            vector<font color="black">&#60;</font>DWORD<font color="black">&#62;</font> tmp;
            tmp.resize<font color="black">(</font>ms.face.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">3</font><font color="black">)</font>;
            <font color="blue">for</font> <font color="black">(</font>DWORD f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>ms.face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>ms.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
                tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>ms.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>;
                tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>ms.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
            <font color="black">}</font>           
        <font color="black">}</font>       
        <font color="blue">if</font> <font color="black">(</font>obj.diffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>   
            obj.diffuseUVBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
            obj.diffuseUVBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
            obj.diffuseUVBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>obj.diffuseUV<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec2<font color="black">)</font><font color="black">*</font>obj.diffuseUV.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
        <font color="black">}</font>       
    <font color="black">}</font>
    UpdateBuffers<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>UpdateBuffers<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>   
        Object <font color="black">&</font>obj<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>;
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.vertexBuffer<font color="black">)</font>
        <font color="black">{</font>
            obj.vertexBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
            obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>obj.vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>obj.vertex.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
        <font color="black">{</font>
            ostringstream oss;
            oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>id <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
            Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        <font color="black">}</font>
        <font color="blue">if</font> <font color="black">(</font>obj.normal.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.normalBuffer<font color="black">)</font>
            <font color="black">{</font>
                obj.normalBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
                obj.normalBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.normalBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>obj.normal<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>obj.normal.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>
                ostringstream oss;
                oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>id <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
                Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font>
            obj.normalBuffer.reset<font color="black">(</font><font color="black">)</font>;
        
        <font color="blue">if</font> <font color="black">(</font>obj.diffuseUV.size<font color="black">(</font><font color="black">)</font><font color="black">!</font><font color="black">=</font><font color="maroon">0</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.diffuseUVBuffer<font color="black">)</font>
            <font color="black">{</font>
                obj.diffuseUVBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
                obj.diffuseUVBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>obj.diffuseUVBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>obj.diffuseUV<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec2<font color="black">)</font><font color="black">*</font>obj.diffuseUV.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>
                ostringstream oss;
                oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>id <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
                Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
        <font color="blue">else</font>
            obj.diffuseUVBuffer.reset<font color="black">(</font><font color="black">)</font>;

        

        <font color="blue">for</font> <font color="black">(</font>DWORD m<font color="black">=</font><font color="maroon">0</font>;m<font color="black">&#60;</font>obj.mesh.size<font color="black">(</font><font color="black">)</font>;m<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            Mesh <font color="black">&</font>mesh<font color="black">=</font>obj.mesh<font color="black">[</font>m<font color="black">]</font>;
            vector<font color="black">&#60;</font>DWORD<font color="black">&#62;</font> indices;
            <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>mesh.face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                indices.push_back<font color="black">(</font>mesh.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">)</font>;
                indices.push_back<font color="black">(</font>mesh.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">)</font>;
                indices.push_back<font color="black">(</font>mesh.face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>mesh.indexBuffer<font color="black">)</font>
            <font color="black">{</font>
                mesh.indexBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
                mesh.indexBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
            <font color="black">}</font>
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>mesh.indexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadIndexData<font color="black">(</font><font color="black">&</font>indices<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,indices.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>
                ostringstream oss;
                oss <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"buffer id:"</font><font color="black">&#60;</font><font color="black">&#60;</font>obj.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>id <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">" Couldn't upload vertex data"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
                Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>oss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
