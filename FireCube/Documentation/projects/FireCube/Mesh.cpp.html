<HTML>
<HEAD>
<TITLE>
Mesh.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL/SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL/SDL_image.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;GL/GLU.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"FireCube.h"</font>
<font color="blue">using</font> <font color="blue">namespace</font> FireCube;

Material<font color="black">:</font><font color="black">:</font>Material<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Material<font color="black">:</font><font color="black">:</font>~Material<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Face<font color="black">:</font><font color="black">:</font>~Face<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
Mesh<font color="black">:</font><font color="black">:</font>Mesh<font color="black">(</font><font color="black">)</font> <font color="black">:</font> material<font color="black">(</font>NULL<font color="black">)</font>
<font color="black">{</font>
    
<font color="black">}</font>
Mesh<font color="black">:</font><font color="black">:</font>~Mesh<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
ModelResource<font color="black">:</font><font color="black">:</font>ModelResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
ModelResource<font color="black">:</font><font color="black">:</font>~ModelResource<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>string<font color="black">(</font><font color="maroon">"Destroyed model with name:"</font><font color="black">)</font><font color="black">)</font>;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font><font color="blue">name</font><font color="black">)</font>;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font><font color="maroon">".\n"</font><font color="black">)</font>;
<font color="black">}</font>

<font color="blue">bool</font> ModelResource<font color="black">:</font><font color="black">:</font>Load<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font>filename<font color="black">)</font>
<font color="black">{</font>
    string<font color="black">:</font><font color="black">:</font>size_type d;
    d<font color="black">=</font>filename.find_last_of<font color="black">(</font><font color="maroon">"."</font><font color="black">)</font>;
    <font color="blue">name</font><font color="black">=</font>filename;
    ostringstream ss;
    ss<font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"Created model with name:"</font><font color="black">&#60;</font><font color="black">&#60;</font>filename<font color="black">&#60;</font><font color="black">&#60;</font>endl;
    Logger<font color="black">:</font><font color="black">:</font>Write<font color="black">(</font>ss.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>d<font color="black">!</font><font color="black">=</font>string<font color="black">:</font><font color="black">:</font>npos<font color="black">)</font>
    <font color="black">{</font>
        string ext<font color="black">=</font>ToLower<font color="black">(</font>filename.substr<font color="black">(</font>d<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font>;
        <font color="blue">if</font> <font color="black">(</font>ext<font color="black">=</font><font color="black">=</font><font color="maroon">"3ds"</font><font color="black">)</font>
        <font color="black">{</font>       
            ifstream f<font color="black">(</font>filename.c_str<font color="black">(</font><font color="black">)</font>,ios<font color="black">:</font><font color="black">:</font>in<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>binary<font color="black">|</font>ios<font color="black">:</font><font color="black">:</font>ate<font color="black">)</font>;
            <font color="blue">if</font> <font color="black">(</font><font color="black">!</font>f.is_open<font color="black">(</font><font color="black">)</font><font color="black">)</font>
            <font color="black">{</font>       
                <font color="blue">return</font> <font color="blue">false</font>;
            <font color="black">}</font>   
            DWORD l<font color="black">=</font>f.tellg<font color="black">(</font><font color="black">)</font>;
            <font color="blue">char</font> <font color="black">*</font>buffer<font color="black">=</font><font color="blue">new</font> <font color="blue">char</font><font color="black">[</font>l<font color="black">]</font>;
            f.seekg<font color="black">(</font><font color="maroon">0</font>,ios_base<font color="black">:</font><font color="black">:</font>beg<font color="black">)</font>;
            f.read<font color="black">(</font>buffer,l<font color="black">)</font>;

            ProcessChunk<font color="black">(</font>buffer<font color="black">)</font>;   
            <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.mesh.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                <font color="black">{</font>
                    Mesh <font color="black">*</font>sm<font color="black">=</font><font color="black">&</font>object<font color="black">[</font>k<font color="black">]</font>.mesh<font color="black">[</font>i<font color="black">]</font>;        
                    <font color="blue">for</font> <font color="black">(</font>DWORD j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>sm<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                    <font color="black">{</font>
                        DWORD idx<font color="black">=</font>sm<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>j<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
                        sm<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>idx<font color="black">]</font>;                
                    <font color="black">}</font>
                    sm<font color="black">-</font><font color="black">&#62;</font>indexBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
                    sm<font color="black">-</font><font color="black">&#62;</font>indexBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
                    vector<font color="black">&#60;</font>DWORD<font color="black">&#62;</font> tmp;
                    tmp.resize<font color="black">(</font>sm<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font><font color="black">*</font><font color="maroon">3</font><font color="black">)</font>;
                    <font color="blue">for</font> <font color="black">(</font>DWORD f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>sm<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                    <font color="black">{</font>
                        tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>sm<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
                        tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font>sm<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font>;
                        tmp<font color="black">[</font>f<font color="black">*</font><font color="maroon">3</font><font color="black">+</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font>sm<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font>;
                    <font color="black">}</font>
                    sm<font color="black">-</font><font color="black">&#62;</font>indexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadIndexData<font color="black">(</font><font color="black">&</font>tmp<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,tmp.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
                <font color="black">}</font>
            <font color="black">}</font>
            CalculateNormals<font color="black">(</font><font color="black">)</font>;

            <font color="blue">delete</font> <font color="black">[</font><font color="black">]</font> buffer;       
            <font color="blue">return</font> <font color="blue">true</font>;
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> <font color="blue">false</font>;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>CalculateNormals<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>   
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        object<font color="black">[</font>k<font color="black">]</font>.normal.resize<font color="black">(</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font><font color="black">)</font>;       
        <font color="blue">for</font> <font color="black">(</font>DWORD n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>           
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>n<font color="black">]</font><font color="black">=</font>vec3<font color="black">(</font><font color="maroon">0</font>,<font color="maroon">0</font>,<font color="maroon">0</font><font color="black">)</font>;        
        <font color="black">}</font>
        <font color="blue">for</font> <font color="black">(</font>DWORD f<font color="black">=</font><font color="maroon">0</font>;f<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.face.size<font color="black">(</font><font color="black">)</font>;f<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            vec3 v1<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
            vec3 v2<font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">-</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font>;
            vec3 n<font color="black">=</font>Cross<font color="black">(</font>v1,v2<font color="black">)</font>;
            n.Normalize<font color="black">(</font><font color="black">)</font>;
            object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.normal<font color="black">=</font>n;
            <font color="green">/*for (unsigned int i=0;i&#60;object[k].vertex.size();i++)                  // Fix texture coordinate problem having certain vertices duplicated. SLOW.
            {
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[0]])
            {               
            object[k].normal[i]+=n;
            count[i]++;             
            }
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[1]])
            {               
            object[k].normal[i]+=n;
            count[i]++;
            }
            if (object[k].vertex[i]==object[k].vertex[object[k].face[f].v[2]])
            {               
            object[k].normal[i]+=n;
            count[i]++;
            }
            }*/</font>
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>object<font color="black">[</font>k<font color="black">]</font>.face<font color="black">[</font>f<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">]</font><font color="black">+</font><font color="black">=</font>n;            
        <font color="black">}</font>       
        <font color="blue">for</font> <font color="black">(</font>DWORD n<font color="black">=</font><font color="maroon">0</font>;n<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>;n<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>           
            object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font>n<font color="black">]</font>.Normalize<font color="black">(</font><font color="black">)</font>;        
        <font color="black">}</font>   
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
        object<font color="black">[</font>k<font color="black">]</font>.normalBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>object<font color="black">[</font>k<font color="black">]</font>.normal<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>object<font color="black">[</font>k<font color="black">]</font>.normal.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    <font color="black">}</font>
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>ApplyTransformation<font color="black">(</font>mat4 <font color="black">&</font>transform<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>i<font color="black">]</font><font color="black">=</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font>i<font color="black">]</font><font color="black">*</font>transform;
        <font color="black">}</font>
        object<font color="black">[</font>k<font color="black">]</font>.vertexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>object<font color="black">[</font>k<font color="black">]</font>.vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>object<font color="black">[</font>k<font color="black">]</font>.vertex.size<font color="black">(</font><font color="black">)</font>,STATIC<font color="black">)</font>;
    <font color="black">}</font>
    CalculateNormals<font color="black">(</font><font color="black">)</font>;
<font color="black">}</font>
DWORD ModelResource<font color="black">:</font><font color="black">:</font>ProcessChunk<font color="black">(</font><font color="blue">char</font> <font color="black">*</font>buffer<font color="black">)</font>
<font color="black">{</font>
    Object <font color="black">*</font>curObject<font color="black">=</font>NULL;
    <font color="blue">if</font> <font color="black">(</font>object.size<font color="black">(</font><font color="black">)</font><font color="black">&#62;</font><font color="maroon">0</font><font color="black">)</font>
        curObject<font color="black">=</font><font color="black">&</font>object<font color="black">[</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>;
    DWORD i<font color="black">=</font><font color="maroon">0</font>,j<font color="black">=</font><font color="maroon">0</font>;  
    Material mat;
    Material <font color="black">*</font>matPtr;
    Mesh sm;
    DWORD numtexcoords,numFaces,numVertices;
    WORD id<font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
    DWORD len<font color="black">=</font><font color="black">*</font><font color="black">(</font>DWORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">2</font><font color="black">)</font>;        
    i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
    <font color="blue">switch</font> <font color="black">(</font>id<font color="black">)</font>
    <font color="black">{</font>
    <font color="blue">case</font> PRIMARY<font color="black">:</font>
        <font color="blue">break</font>;
    <font color="blue">case</font> EDIT3DS<font color="black">:</font>
        <font color="blue">break</font>;
    <font color="blue">case</font> NAMED_OBJECT<font color="black">:</font>
            object.push_back<font color="black">(</font>Object<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
            object<font color="black">[</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font>.<font color="blue">name</font><font color="black">=</font>buffer<font color="black">+</font>i;          
            i<font color="black">+</font><font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>strlen<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">+</font><font color="maroon">1</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> OBJ_MESH<font color="black">:</font>
        <font color="blue">break</font>;
    <font color="blue">case</font> MESH_VERTICES<font color="black">:</font>         
        <font color="blue">float</font> x,y,z;
        numVertices<font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>vertex.resize<font color="black">(</font>numVertices<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="blue">for</font> <font color="black">(</font>j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>numVertices;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            x<font color="black">=</font><font color="black">*</font><font color="black">(</font><font color="blue">float</font><font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
            z<font color="black">=</font><font color="black">-</font><font color="black">*</font><font color="black">(</font><font color="blue">float</font><font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">4</font><font color="black">)</font>;
            y<font color="black">=</font><font color="black">*</font><font color="black">(</font><font color="blue">float</font><font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">8</font><font color="black">)</font>;
            curObject<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>j<font color="black">]</font>.Set<font color="black">(</font>x,y,z<font color="black">)</font>;
            i<font color="black">+</font><font color="black">=</font><font color="maroon">12</font>;
        <font color="black">}</font>
        curObject<font color="black">-</font><font color="black">&#62;</font>vertexBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>vertexBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>vertexBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec3<font color="black">)</font><font color="black">*</font>numVertices,STATIC<font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MESH_FACES<font color="black">:</font>            
        numFaces<font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>face.resize<font color="black">(</font>numFaces<font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>numFaces;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>j<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
            curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>j<font color="black">]</font>.v<font color="black">[</font><font color="maroon">1</font><font color="black">]</font><font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">2</font><font color="black">)</font>;
            curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>j<font color="black">]</font>.v<font color="black">[</font><font color="maroon">2</font><font color="black">]</font><font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">4</font><font color="black">)</font>;
            i<font color="black">+</font><font color="black">=</font><font color="maroon">8</font>;
        <font color="black">}</font>
        <font color="blue">break</font>;
    <font color="blue">case</font> MESH_TEX_VERT<font color="black">:</font>
        numtexcoords<font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>uv.resize<font color="black">(</font>numtexcoords<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="blue">for</font> <font color="black">(</font>j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>numtexcoords;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            curObject<font color="black">-</font><font color="black">&#62;</font>uv<font color="black">[</font>j<font color="black">]</font>.x<font color="black">=</font><font color="black">*</font><font color="black">(</font><font color="blue">float</font><font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
            curObject<font color="black">-</font><font color="black">&#62;</font>uv<font color="black">[</font>j<font color="black">]</font>.y<font color="black">=</font><font color="maroon">1</font>.0f<font color="black">-</font><font color="black">*</font><font color="black">(</font><font color="blue">float</font><font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">4</font><font color="black">)</font>;
            i<font color="black">+</font><font color="black">=</font><font color="maroon">8</font>;
        <font color="black">}</font>
        curObject<font color="black">-</font><font color="black">&#62;</font>uvBuffer<font color="black">=</font>Buffer<font color="black">(</font><font color="blue">new</font> BufferResource<font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>uvBuffer<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font><font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>uvBuffer<font color="black">-</font><font color="black">&#62;</font>LoadData<font color="black">(</font><font color="black">&</font>curObject<font color="black">-</font><font color="black">&#62;</font>uv<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>,<font color="blue">sizeof</font><font color="black">(</font>vec2<font color="black">)</font><font color="black">*</font>numtexcoords,STATIC<font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MESH_MATERIAL<font color="black">:</font>     
        sm.material<font color="black">=</font>GetMaterialByName<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>strlen<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">+</font><font color="maroon">1</font>;
        numFaces<font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        sm.face.resize<font color="black">(</font>numFaces<font color="black">)</font>;
        <font color="blue">for</font> <font color="black">(</font>j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font>numFaces;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            sm.face<font color="black">[</font>j<font color="black">]</font>.v<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;
            i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="black">}</font>           
        curObject<font color="black">-</font><font color="black">&#62;</font>mesh.push_back<font color="black">(</font>sm<font color="black">)</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MATERIAL<font color="black">:</font>
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_NAME<font color="black">:</font>              
        mat.<font color="blue">name</font><font color="black">=</font>buffer<font color="black">+</font>i;      
        <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material.insert<font color="black">(</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material.begin<font color="black">(</font><font color="black">)</font>,mat<font color="black">)</font>;      
        i<font color="black">+</font><font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>strlen<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">+</font><font color="maroon">1</font>;       
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_AMBIENT<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        matPtr<font color="black">=</font><font color="black">&</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;      
        matPtr<font color="black">-</font><font color="black">&#62;</font>ambient<font color="black">=</font>vec3<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">2</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">3</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_DIFFUSE<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        matPtr<font color="black">=</font><font color="black">&</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;      
        matPtr<font color="black">-</font><font color="black">&#62;</font>diffuse<font color="black">=</font>vec3<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">2</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">3</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_SPECULAR<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        matPtr<font color="black">=</font><font color="black">&</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;      
        matPtr<font color="black">-</font><font color="black">&#62;</font>specular<font color="black">=</font>vec3<font color="black">(</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">1</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f,<font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>BYTE<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">+</font><font color="maroon">2</font><font color="black">)</font><font color="black">)</font><font color="black">/</font><font color="maroon">255</font>.0f<font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">3</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_SHININESS<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_SHIN2PCT<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        matPtr<font color="black">=</font><font color="black">&</font><font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>material<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;
        matPtr<font color="black">-</font><font color="black">&#62;</font>shininess<font color="black">=</font><font color="black">(</font><font color="blue">float</font><font color="black">)</font><font color="black">(</font><font color="black">*</font><font color="black">(</font>WORD<font color="black">*</font><font color="black">)</font><font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">)</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_SHIN3PCT<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">6</font>;
        i<font color="black">+</font><font color="black">=</font><font color="maroon">2</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_TEXMAP<font color="black">:</font>
        i<font color="black">+</font><font color="black">=</font><font color="maroon">8</font>;
        <font color="blue">break</font>;
    <font color="blue">case</font> MAT_TEXFLNM<font color="black">:</font>
        matPtr<font color="black">=</font><font color="black">&</font>material<font color="black">[</font><font color="maroon">0</font><font color="black">]</font>;                        
        matPtr<font color="black">-</font><font color="black">&#62;</font>texture<font color="black">[</font><font color="maroon">0</font><font color="black">]</font><font color="black">=</font>Renderer<font color="black">:</font><font color="black">:</font>GetTextureManager<font color="black">(</font><font color="black">)</font><font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;     
        i<font color="black">+</font><font color="black">=</font><font color="black">(</font>DWORD<font color="black">)</font>strlen<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font><font color="black">+</font><font color="maroon">1</font>;
        <font color="blue">break</font>;
    <font color="blue">default</font><font color="black">:</font>    
        i<font color="black">=</font>len;
        <font color="blue">break</font>;

    <font color="black">}</font>
    <font color="blue">while</font> <font color="black">(</font>i<font color="black">&#60;</font>len<font color="black">)</font>
        i<font color="black">+</font><font color="black">=</font>ProcessChunk<font color="black">(</font>buffer<font color="black">+</font>i<font color="black">)</font>;

    <font color="blue">return</font> len;
<font color="black">}</font>
Material <font color="black">*</font>ModelResource<font color="black">:</font><font color="black">:</font>GetMaterialByName<font color="black">(</font><font color="blue">const</font> string <font color="black">&</font><font color="blue">name</font><font color="black">)</font>
<font color="black">{</font>
    <font color="blue">for</font> <font color="black">(</font>DWORD i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>material.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        <font color="blue">if</font> <font color="black">(</font>material<font color="black">[</font>i<font color="black">]</font>.<font color="blue">name</font><font color="black">=</font><font color="black">=</font><font color="blue">name</font><font color="black">)</font>
            <font color="blue">return</font> <font color="black">&</font>material<font color="black">[</font>i<font color="black">]</font>;
    <font color="black">}</font>
    <font color="blue">return</font> NULL;
<font color="black">}</font>
Model ModelResource<font color="black">:</font><font color="black">:</font>Reduce<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    Model model<font color="black">(</font><font color="blue">new</font> ModelResource<font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> l<font color="black">=</font><font color="maroon">0</font>;l<font color="black">&#60;</font>object.size<font color="black">(</font><font color="black">)</font>;l<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>
        Object <font color="black">*</font>curObject;
        model<font color="black">-</font><font color="black">&#62;</font>object.push_back<font color="black">(</font>Object<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
        curObject<font color="black">=</font><font color="black">&</font><font color="black">(</font>model<font color="black">-</font><font color="black">&#62;</font>object<font color="black">[</font>model<font color="black">-</font><font color="black">&#62;</font>object.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font><font color="black">]</font><font color="black">)</font>;
        curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.face;
        curObject<font color="black">-</font><font color="black">&#62;</font><font color="blue">name</font><font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.<font color="blue">name</font>;

        <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> i<font color="black">=</font><font color="maroon">0</font>;i<font color="black">&#60;</font>curObject<font color="black">-</font><font color="black">&#62;</font>face.size<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
        <font color="black">{</font>
            <font color="blue">for</font> <font color="black">(</font><font color="blue">unsigned</font> <font color="blue">int</font> j<font color="black">=</font><font color="maroon">0</font>;j<font color="black">&#60;</font><font color="maroon">3</font>;j<font color="black">+</font><font color="black">+</font><font color="black">)</font>
            <font color="black">{</font>
                vec3 v<font color="black">=</font>object<font color="black">[</font>l<font color="black">]</font>.vertex<font color="black">[</font>curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">]</font>;
                <font color="blue">bool</font> found<font color="black">=</font><font color="blue">false</font>;
                <font color="blue">unsigned</font> <font color="blue">int</font> k;
                <font color="blue">for</font> <font color="black">(</font>k<font color="black">=</font><font color="maroon">0</font>;k<font color="black">&#60;</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font>;k<font color="black">+</font><font color="black">+</font><font color="black">)</font>
                <font color="black">{</font>
                    <font color="blue">if</font> <font color="black">(</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex<font color="black">[</font>k<font color="black">]</font><font color="black">=</font><font color="black">=</font>v<font color="black">)</font>
                    <font color="black">{</font>
                        found<font color="black">=</font><font color="blue">true</font>;
                        <font color="blue">break</font>;
                    <font color="black">}</font>
                <font color="black">}</font>
                <font color="blue">if</font> <font color="black">(</font>found<font color="black">=</font><font color="black">=</font><font color="blue">false</font><font color="black">)</font>
                <font color="black">{</font>
                    curObject<font color="black">-</font><font color="black">&#62;</font>vertex.push_back<font color="black">(</font>v<font color="black">)</font>;
                    curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>curObject<font color="black">-</font><font color="black">&#62;</font>vertex.size<font color="black">(</font><font color="black">)</font><font color="maroon">-1</font>;
                <font color="black">}</font>
                <font color="blue">else</font>
                <font color="black">{</font>
                    curObject<font color="black">-</font><font color="black">&#62;</font>face<font color="black">[</font>i<font color="black">]</font>.v<font color="black">[</font>j<font color="black">]</font><font color="black">=</font>k;
                <font color="black">}</font>
            <font color="black">}</font>
        <font color="black">}</font>
    <font color="black">}</font>
    <font color="blue">return</font> model;
<font color="black">}</font>
<font color="blue">void</font> ModelResource<font color="black">:</font><font color="black">:</font>SetProgram<font color="black">(</font><font color="blue">const</font> Program <font color="black">&</font>program<font color="black">)</font>
<font color="black">{</font>   
    vector<font color="black">&#60;</font>Material<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>material.begin<font color="black">(</font><font color="black">)</font>;
    <font color="blue">for</font> <font color="black">(</font>;i<font color="black">!</font><font color="black">=</font>material.end<font color="black">(</font><font color="black">)</font>;i<font color="black">+</font><font color="black">+</font><font color="black">)</font>
    <font color="black">{</font>               
        i<font color="black">-</font><font color="black">&#62;</font>program<font color="black">=</font>program;
    <font color="black">}</font>
<font color="black">}</font>

</PRE>
</BODY>
</HTML>
