<HTML>
<HEAD>
<TITLE>
ShaderGenerator.cpp
</TITLE>
</HEAD>
<BODY>
<PRE>
<font color="blue">#include</font> <font color="maroon">&#60;string&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;vector&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;fstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;iostream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;sstream&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;map&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;queue&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/shared_ptr.hpp&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;boost/weak_ptr.hpp&#62;</font>
<font color="blue">using</font> <font color="blue">namespace</font> std;
<font color="blue">#include</font> <font color="maroon">&#60;SDL.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;SDL_image.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">&#60;windows.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"GLee.h"</font>
<font color="blue">#include</font> <font color="maroon">&#60;GL/GLU.h&#62;</font>
<font color="blue">#include</font> <font color="maroon">"utils.h"</font>  
<font color="blue">#include</font> <font color="maroon">"Logger.h"</font>
<font color="blue">#include</font> <font color="maroon">"ResourceManager.h"</font>
<font color="blue">#include</font> <font color="maroon">"Timer.h"</font>
<font color="blue">#include</font> <font color="maroon">"MyMath.h"</font> 
<font color="blue">#include</font> <font color="maroon">"BoundingBox.h"</font>
<font color="blue">#include</font> <font color="maroon">"Texture.h"</font>        
<font color="blue">#include</font> <font color="maroon">"Buffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Shaders.h"</font>
<font color="blue">#include</font> <font color="maroon">"Geometry.h"</font>   
<font color="blue">#include</font> <font color="maroon">"FrameBuffer.h"</font>
<font color="blue">#include</font> <font color="maroon">"Image.h"</font>
<font color="blue">#include</font> <font color="maroon">"Font.h"</font>
<font color="blue">#include</font> <font color="maroon">"ShaderGenerator.h"</font>
<font color="blue">#include</font> <font color="maroon">"Renderer.h"</font>               
<font color="blue">#include</font> <font color="maroon">"Application.h"</font>

<font color="blue">using</font> <font color="blue">namespace</font> FireCube;
RenderState<font color="black">:</font><font color="black">:</font>RenderState<font color="black">(</font><font color="black">)</font> <font color="black">:</font> directionalLighting<font color="black">(</font><font color="blue">false</font><font color="black">)</font>, diffuseTexture<font color="black">(</font><font color="blue">false</font><font color="black">)</font>, fog<font color="black">(</font><font color="blue">false</font><font color="black">)</font>
<font color="black">{</font>

<font color="black">}</font>
<font color="blue">void</font> RenderState<font color="black">:</font><font color="black">:</font>FromMaterial<font color="black">(</font>Material mat<font color="black">)</font>
<font color="black">{</font>
    <font color="blue">if</font> <font color="black">(</font>mat<font color="black">-</font><font color="black">&#62;</font>diffuseTexture<font color="black">)</font>
        <font color="blue">this</font><font color="black">-</font><font color="black">&#62;</font>diffuseTexture<font color="black">=</font><font color="blue">true</font>;
<font color="black">}</font>
<font color="blue">void</font> RenderState<font color="black">:</font><font color="black">:</font>SetDirectionalLighting<font color="black">(</font><font color="blue">bool</font> enable<font color="black">)</font>
<font color="black">{</font>
    directionalLighting<font color="black">=</font>enable;
<font color="black">}</font>
<font color="blue">void</font> RenderState<font color="black">:</font><font color="black">:</font>SetFog<font color="black">(</font><font color="blue">bool</font> enable<font color="black">)</font>
<font color="black">{</font>
    fog<font color="black">=</font>enable;
<font color="black">}</font>
DWORD RenderState<font color="black">:</font><font color="black">:</font>ToInt<font color="black">(</font><font color="black">)</font>
<font color="black">{</font>
    DWORD ret<font color="black">=</font><font color="maroon">0</font>;
    <font color="blue">if</font> <font color="black">(</font>directionalLighting<font color="black">)</font>
        ret<font color="black">|</font><font color="black">=</font><font color="maroon">1</font>;
    <font color="blue">if</font> <font color="black">(</font>fog<font color="black">)</font>
        ret<font color="black">|</font><font color="black">=</font><font color="maroon">2</font>;
    <font color="blue">if</font> <font color="black">(</font>diffuseTexture<font color="black">)</font>
        ret<font color="black">|</font><font color="black">=</font><font color="maroon">4</font>;
    <font color="blue">return</font> ret;
<font color="black">}</font>
Program ShaderGenerator<font color="black">:</font><font color="black">:</font>GenerateProgram<font color="black">(</font>RenderState <font color="black">&</font>renderState<font color="black">)</font>
<font color="black">{</font>
    map<font color="black">&#60;</font>DWORD,Program<font color="black">&#62;</font><font color="black">:</font><font color="black">:</font>iterator i<font color="black">=</font>programs.find<font color="black">(</font>renderState.ToInt<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    <font color="blue">if</font> <font color="black">(</font>i<font color="black">!</font><font color="black">=</font>programs.end<font color="black">(</font><font color="black">)</font><font color="black">)</font>
        <font color="blue">return</font> i<font color="black">-</font><font color="black">&#62;</font>second;
    
    Program program<font color="black">(</font><font color="blue">new</font> ProgramResource<font color="black">)</font>;
    Shader vshader<font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;
    ostringstream vshaderCode;
    vshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"varying vec3 normal;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font><font color="maroon">"void  main()"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"{"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.diffuseTexture<font color="black">)</font>
        vshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"gl_TexCoord[0]=gl_MultiTexCoord0;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    vshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"normal = gl_NormalMatrix * gl_Normal;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    vshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"gl_Position = ftransform();"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"}"</font>;
    Shader fshader<font color="black">(</font><font color="blue">new</font> ShaderResource<font color="black">)</font>;
    ostringstream fshaderCode;  
    fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"varying vec3 normal;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.directionalLighting<font color="black">)</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"uniform vec4 lightDiffuse;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.diffuseTexture<font color="black">)</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"uniform sampler2D diffuseMap;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.directionalLighting<font color="black">)</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"uniform vec3 lightDir;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.fog<font color="black">)</font>
    <font color="black">{</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"uniform float fogDensity;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"uniform vec4 fogColor;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="black">}</font>
    fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"void main()"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"{"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"vec4 color=gl_FrontMaterial.diffuse;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.diffuseTexture<font color="black">)</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"color*=texture2D(diffuseMap,gl_TexCoord[0].xy);"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="blue">if</font> <font color="black">(</font>renderState.directionalLighting<font color="black">)</font>
    <font color="black">{</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"vec3 n=normalize(normal);"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"lightDir=normalize(lightDir);"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"float d=max(dot(n,lightDir),0.0);"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"color *= lightDiffuse*d;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="black">}</font>
    <font color="blue">if</font> <font color="black">(</font>renderState.fog<font color="black">)</font>
    <font color="black">{</font>
        fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"const float LOG2 = 1.442695;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"float z = gl_FragCoord.z / gl_FragCoord.w;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"float fogFactor = exp2( -fogDensity* fogDensity* z * z * LOG2 );"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"fogFactor = clamp(fogFactor, 0.0, 1.0);"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                    <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"color = mix(fogColor, color, fogFactor );"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    <font color="black">}</font>
    fshaderCode <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"gl_FragColor=color;"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl
                <font color="black">&#60;</font><font color="black">&#60;</font> <font color="maroon">"}"</font> <font color="black">&#60;</font><font color="black">&#60;</font> endl;
    vshader<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>VERTEX_SHADER,vshaderCode.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    fshader<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>FRAGMENT_SHADER,fshaderCode.str<font color="black">(</font><font color="black">)</font><font color="black">)</font>;
    program<font color="black">-</font><font color="black">&#62;</font>Create<font color="black">(</font>vshader,fshader<font color="black">)</font>;
    programs<font color="black">[</font>renderState.ToInt<font color="black">(</font><font color="black">)</font><font color="black">]</font><font color="black">=</font>program;
    <font color="blue">return</font> program;
<font color="black">}</font>
</PRE>
</BODY>
</HTML>
